<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="p-4">

  <!-- æµ®åŠ¨æŒ‰é’® -->
  <button onclick="toggleAI()"
    class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
    ğŸ¤–
  </button>

  <!-- AI çª—å£ -->
  <div id="ai-panel"
    class="hidden fixed bottom-20 right-4 w-[320px] bg-white rounded-xl shadow-xl flex flex-col">

    <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
      <span>AI í•œì ì„ ìƒë‹˜</span>
      <button onclick="toggleAI()">âœ–</button>
    </div>

    <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

    <div class="p-3 border-t flex gap-2">
      <input id="input"
        class="flex-1 border rounded px-2 py-1"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" />
      <button onclick="send()"
        class="bg-orange-500 text-white px-3 py-1 rounded">
        ë³´ë‚´ê¸°
      </button>
    </div>

    <div class="text-xs text-center text-gray-500 pb-2">
      ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel /api/gemini
    </div>
  </div>

<script>
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");

// âœ… å…³é”®ï¼šGitHub Pages å¿…é¡»ç”¨å®Œæ•´ Vercel åœ°å€
const API_URL = "https://hanjiapass.vercel.app/api/gemini";

function toggleAI() {
  panel.classList.toggle("hidden");
}

function addMsg(text, who) {
  const div = document.createElement("div");
  div.className = who === "user" ? "text-right" : "text-left text-gray-800";

  // ç”¨ <pre> ä¿ç•™æ¢è¡Œ
  div.innerHTML = `<span class="inline-block px-3 py-2 rounded-lg ${
    who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"
  }"><pre>${escapeHtml(text)}</pre></span>`;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// é˜²æ­¢ç”¨æˆ·è¾“å…¥å¯¼è‡´ HTML æ³¨å…¥
function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  addMsg(msg, "user");
  input.value = "";

  try {
    const res = await fetch("/api/gemini", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      // âœ… å…³é”®ï¼šåç«¯è¯»çš„æ˜¯ messageï¼Œä¸æ˜¯ prompt
      body: JSON.stringify({ message: msg })
    });

    const data = await res.json();

    if (!res.ok) {
      // å°½é‡æŠŠåç«¯è¿”å›çš„é”™è¯¯å±•ç¤ºå‡ºæ¥ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•
      const errMsg = data?.error || ("HTTP " + res.status);
      addMsg("ì˜¤ë¥˜: " + errMsg, "ai");
      return;
    }

    addMsg(data.text || "(ì‘ë‹µ ì—†ìŒ)", "ai");

  } catch (e) {
    addMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.\n" + e.message, "ai");
  }
}

// åˆå§‹æ¬¢è¿
addMsg("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š\nê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ë¬¸ë²•ì„ ë¬¼ì–´ë³´ì„¸ìš”!", "ai");

// å›è½¦å‘é€
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});
</script>

</body>
</html>

