<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    .bubble { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="p-4">

<button onclick="toggleAI()"
  class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
  ğŸ¤–
</button>

<div id="ai-panel"
  class="hidden fixed bottom-20 right-4 w-[380px] bg-white rounded-xl shadow-xl flex flex-col">

  <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
    <span id="uiTitle">AI í•œì ì„ ìƒë‹˜</span>
    <button onclick="toggleAI()">âœ–</button>
  </div>

  <!-- æ§åˆ¶åŒº -->
  <div class="px-3 pt-3 pb-2 border-b text-xs space-y-2">
    <div class="flex items-center gap-2">
      <input id="ttsToggle" type="checkbox" checked class="accent-orange-500" />
      <label id="uiTtsLabel">ì½ì–´ì£¼ê¸°(TTS)</label>
    </div>

    <div class="flex items-center gap-2">
      <span id="uiVoiceLabel" class="w-[70px] text-gray-600">ìŒìƒ‰</span>
      <select id="voiceSelect" class="flex-1 border rounded px-2 py-1 text-xs"></select>
    </div>

    <div class="flex items-center gap-2">
      <span id="uiExplainLabel" class="w-[70px] text-gray-600">ì„¤ëª… ì–¸ì–´</span>
      <select id="explainLang" class="flex-1 border rounded px-2 py-1 text-xs">
        <option value="ko" selected>í•œêµ­ì–´</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="en">English</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>
  </div>

  <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

  <div class="p-3 border-t flex gap-2">
    <input id="input" class="flex-1 border rounded px-2 py-2"
      placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦"
      onkeydown="if(event.key==='Enter') send();" />
    <button id="uiSendBtn" onclick="send()" class="bg-orange-500 text-white px-4 py-2 rounded">
      ë³´ë‚´ê¸°
    </button>
  </div>

  <div id="uiKeyMode" class="text-xs text-center text-gray-500 pb-2">
    ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel API
  </div>
</div>

<script>
/* =========================
   1) UI å¤šè¯­è¨€æ–‡æ¡ˆ
========================= */
const UI_TEXT = {
  ko: {
    title: "AI í•œì ì„ ìƒë‹˜",
    inputPlaceholder: "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦",
    send: "ë³´ë‚´ê¸°",
    explainLang: "ì„¤ëª… ì–¸ì–´",
    tts: "ì½ì–´ì£¼ê¸°(TTS)",
    voice: "ìŒìƒ‰",
    keyMode: "ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel API",
    welcome: "ì•ˆë…•í•˜ì„¸ìš” ğŸ™‚\nì¤‘êµ­ì–´ ì§ˆë¬¸, ë°”ë¡œ ë¬¼ì–´ë³´ì„¸ìš”!"
  },
  en: {
    title: "AI Chinese Teacher",
    inputPlaceholder: "Ask your questionâ€¦",
    send: "Send",
    explainLang: "Explanation language",
    tts: "Read aloud (TTS)",
    voice: "Voice",
    keyMode: "ğŸ” Key protection: Vercel API",
    welcome: "Hi ğŸ™‚\nAsk me anything about Chinese!"
  },
  ja: {
    title: "AI ä¸­å›½èªå…ˆç”Ÿ",
    inputPlaceholder: "è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦",
    send: "é€ä¿¡",
    explainLang: "èª¬æ˜è¨€èª",
    tts: "èª­ã¿ä¸Šã’(TTS)",
    voice: "éŸ³å£°",
    keyMode: "ğŸ” ã‚­ãƒ¼ä¿è­·: Vercel API",
    welcome: "ã“ã‚“ã«ã¡ã¯ ğŸ™‚\nä¸­å›½èªã€æ°—è»½ã«èã„ã¦ãã ã•ã„ã€‚"
  },
  zh: {
    title: "AI æ±‰å­—è€å¸ˆ",
    inputPlaceholder: "è¯·è¾“å…¥ä½ çš„é—®é¢˜â€¦",
    send: "å‘é€",
    explainLang: "è¯´æ˜è¯­è¨€",
    tts: "æœ—è¯»(TTS)",
    voice: "éŸ³è‰²",
    keyMode: "ğŸ” å¯†é’¥ä¿æŠ¤ï¼šVercel API",
    welcome: "ä½ å¥½ ğŸ™‚\næœ‰ä¸­æ–‡é—®é¢˜ï¼Œç›´æ¥é—®æˆ‘å§ã€‚"
  }
};

/* =========================
   2) DOM
========================= */
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");
const explainLang = document.getElementById("explainLang");
const ttsToggle = document.getElementById("ttsToggle");
const voiceSelect = document.getElementById("voiceSelect");

const uiTitle = document.getElementById("uiTitle");
const uiTtsLabel = document.getElementById("uiTtsLabel");
const uiVoiceLabel = document.getElementById("uiVoiceLabel");
const uiExplainLabel = document.getElementById("uiExplainLabel");
const uiSendBtn = document.getElementById("uiSendBtn");
const uiKeyMode = document.getElementById("uiKeyMode");

/* âœ… ç»å¯¹åœ°å€ */
const API_URL = "https://hanjiapass.vercel.app/api/gemini";

function toggleAI() {
  panel.classList.toggle("hidden");
}

/* =========================
   3) æ˜¾ç¤ºæ¸…ç†ï¼šä¸æ˜¾ç¤º ** ## ç­‰
========================= */
function cleanForDisplay(text) {
  return String(text)
    .replace(/```[\s\S]*?```/g, "")
    .replace(/\*\*(.*?)\*\*/g, "$1")
    .replace(/#+\s*/g, "")
    .replace(/-{3,}/g, "")
    .trim();
}

/* =========================
   4) ç”Ÿæˆæ¶ˆæ¯æ°”æ³¡ï¼ˆæ”¯æŒåç»­â€œæ‰“å­—æœºâ€æ›´æ–°å†…å®¹ï¼‰
========================= */
function createMsgBubble(initialText, who) {
  const wrap = document.createElement("div");
  wrap.className = who === "user" ? "text-right" : "text-left";

  const bubbleClass = who === "user" ? "bg-orange-500 text-white" : "bg-gray-200";

  wrap.innerHTML = `
    <span class="inline-block px-3 py-2 rounded-lg ${bubbleClass}">
      <div class="bubble"></div>
    </span>
  `;

  const bubbleDiv = wrap.querySelector(".bubble");
  bubbleDiv.textContent = cleanForDisplay(initialText);

  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;

  return { wrap, bubbleDiv };
}

function addMsg(text, who) {
  createMsgBubble(text, who);
}

/* =========================
   5) UI è·Ÿéšè¯­è¨€åˆ‡æ¢
========================= */
function applyUIText(lang) {
  const t = UI_TEXT[lang] || UI_TEXT.ko;

  uiTitle.innerText = t.title;
  input.placeholder = t.inputPlaceholder;
  uiSendBtn.innerText = t.send;

  uiTtsLabel.innerText = t.tts;
  uiVoiceLabel.innerText = t.voice;
  uiExplainLabel.innerText = t.explainLang;
  uiKeyMode.innerText = t.keyMode;

  chat.innerHTML = "";
  addMsg(t.welcome, "ai");
}

/* =========================
   6) TTSï¼šåªè¯»ä¸­æ–‡ï¼Œä¸è¯»ç¬¦å·
========================= */
let voices = [];

function loadVoices() {
  voices = window.speechSynthesis.getVoices() || [];
  voiceSelect.innerHTML = "";

  if (!voices.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "(No voices yet)";
    voiceSelect.appendChild(opt);
    return;
  }

  voices.forEach((v, idx) => {
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `${v.name} - ${v.lang}`;
    voiceSelect.appendChild(opt);
  });

  voiceSelect.value = "0";
}

window.speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

function extractChineseForTTS(text) {
  const s = String(text);
  const onlyHan = s.match(/[\u4e00-\u9fff]+/g);
  if (!onlyHan) return "";
  return onlyHan.join("ï¼Œ");
}

function speakChinese(text) {
  if (!ttsToggle.checked) return;

  const toSpeak = extractChineseForTTS(text);
  if (!toSpeak) return;

  window.speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(toSpeak);
  const idx = parseInt(voiceSelect.value, 10);
  if (!Number.isNaN(idx) && voices[idx]) u.voice = voices[idx];

  u.rate = 1.0;
  u.pitch = 1.1;

  window.speechSynthesis.speak(u);
}

/* =========================
   7) æ‰“å­—æœº/æµå¼æ˜¾ç¤ºï¼ˆå…³é”®ï¼‰
   - AI å›å¤ä¸€æ‹¿åˆ°å°±å¼€å§‹é€å­—æ˜¾ç¤º
   - ç”¨æˆ·æ„Ÿè§‰â€œé©¬ä¸Šåœ¨ç­”â€
========================= */
let typingTimer = null;

function stopTyping() {
  if (typingTimer) {
    clearInterval(typingTimer);
    typingTimer = null;
  }
}

function typewriterRender(bubbleDiv, fullText, options = {}) {
  stopTyping();

  const speed = options.speed ?? 18; // æ•°å­—è¶Šå°è¶Šå¿«
  const cleaned = cleanForDisplay(fullText);

  bubbleDiv.textContent = ""; // æ¸…ç©ºï¼Œå¼€å§‹æ‰“å­—

  let i = 0;
  typingTimer = setInterval(() => {
    i++;

    // ä¸€æ¬¡åŠ  1 ä¸ªå­—ç¬¦
    bubbleDiv.textContent = cleaned.slice(0, i);

    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    chat.scrollTop = chat.scrollHeight;

    if (i >= cleaned.length) {
      stopTyping();
    }
  }, speed);
}

/* =========================
   8) å‘é€è¯·æ±‚
========================= */
async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  // å¦‚æœ AI æ­£åœ¨æ‰“å­—ï¼Œç”¨æˆ·å†å‘æ–°æ¶ˆæ¯æ—¶å…ˆåœæ­¢
  stopTyping();

  createMsgBubble(msg, "user");
  input.value = "";

  // å…ˆæ”¾ä¸€ä¸ªâ€œAI æ­£åœ¨æ€è€ƒâ€çš„æ°”æ³¡ï¼Œè®©ç”¨æˆ·å®Œå…¨ä¸ç„¦è™‘
  const thinkingText = {
    ko: "ì ê¹ë§Œìš” ğŸ™‚",
    en: "One sec ğŸ™‚",
    ja: "ã¡ã‚‡ã£ã¨å¾…ã£ã¦ã­ ğŸ™‚",
    zh: "ç­‰ä¸€ä¸‹ğŸ™‚"
  }[explainLang.value] || "ì ê¹ë§Œìš” ğŸ™‚";

  const { bubbleDiv } = createMsgBubble(thinkingText, "ai");

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        prompt: msg,
        explainLang: explainLang.value
      })
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data?.error || ("HTTP " + res.status));

    const answer = data.text || "(ì‘ë‹µ ì—†ìŒ)";

    // âœ… ä¸€æ‹¿åˆ°ç­”æ¡ˆå°±å¼€å§‹â€œæµå¼æ˜¾ç¤ºâ€
    typewriterRender(bubbleDiv, answer, { speed: 14 });

    // âœ… æœ—è¯»ï¼šç­‰æ‰“å­—å¼€å§‹åç«‹åˆ»è¯»ä¸­æ–‡ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆç­‰æ‰“å®Œå†è¯»ï¼‰
    speakChinese(answer);

  } catch (e) {
    bubbleDiv.textContent = "ì˜¤ë¥˜: " + (e.message || "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
  }
}

/* =========================
   9) åˆå§‹åŒ– & ç›‘å¬è¯­è¨€åˆ‡æ¢
========================= */
applyUIText(explainLang.value);

explainLang.addEventListener("change", () => {
  stopTyping();
  applyUIText(explainLang.value);
});
</script>

</body>
</html>
