<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>HanjaPass PRO - AI í•œì í•™ì›</title>

  <!-- âœ… Tailwind CDN: ê°œë°œìš© OK / ìš´ì˜ì‹œì—” ì„¤ì¹˜ ê¶Œì¥ (ê²½ê³ ëŠ” ë¬´ì‹œí•´ë„ ê¸°ëŠ¥ì—” ì˜í–¥ ì—†ìŒ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- âœ… favicon 404 ì—†ì• ê¸°(ì„ íƒ): ì•„ì´ì½˜ íŒŒì¼ì´ ì—†ì–´ë„ ê´œì°®ì§€ë§Œ 404 ê²½ê³ ê°€ ë³´ê¸° ì‹«ìœ¼ë©´ ì•„ë˜ í•œ ì¤„ ìœ ì§€ -->
  <link rel="icon" href="data:," />

  <style>
    /* è‘£äº‹é•¿äº²è‡ªè®¾è®¡çš„éŸ©å¼æç®€é£æ ¼ */
    body {
      background: #fffaf5;
      font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
      margin: 0;
      padding: 20px;
      -webkit-tap-highlight-color: transparent;
    }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* æ±‰å­—å¡ç‰‡ï¼šæœå†»è´¨æ„Ÿ */
    .word-card {
      background: white;
      border-radius: 40px;
      border: 4px solid #fff1e6;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
      text-align: center;
      transition: transform 0.2s;
    }
    .word-card:active { transform: scale(0.98); }

    .jelly-box {
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      border-radius: 30px;
      box-shadow: 5px 5px 10px #ebebeb, -5px -5px 10px #ffffff;
      border: 2px solid rgba(255,255,255,0.9);
      padding: 20px 40px;
      cursor: pointer;
      display: inline-block;
    }

    /* æŒ‰é’®æ ·å¼ */
    .level-btn {
      padding: 8px 20px;
      border-radius: 15px;
      background: white;
      border: 2px solid #eee;
      font-weight: 800;
      color: #888;
      white-space: nowrap;
      margin-right: 8px;
      transition: 0.3s;
    }
    .active-level { background: #333 !important; color: white !important; border-color: #333 !important; }

    /* AI èŠå¤©çª—ï¼šæ‚¬æµ®æ„Ÿ */
    #ai-window {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 320px;
      height: 450px;
      background: white;
      border-radius: 30px;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      display: none;
      flex-direction: column;
      z-index: 1000;
      border: 3px solid #333;
      overflow: hidden;
    }

    .msg-ai {
      background: #f1f1f1;
      border-radius: 15px 15px 15px 5px;
      padding: 10px 15px;
      align-self: flex-start;
      max-width: 85%;
      font-size: 14px;
      margin-bottom: 10px;
      line-height: 1.5;
      color: #333;
      white-space: pre-wrap;
    }

    .msg-user {
      background: #ff7e5f;
      color: white;
      border-radius: 15px 15px 5px 15px;
      padding: 10px 15px;
      align-self: flex-end;
      max-width: 85%;
      font-size: 14px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }

    /* æ‚¬æµ®çƒæŒ‰é’® */
    .ai-fab {
      position: fixed;
      bottom: 30px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #333;
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      z-index: 999;
      cursor: pointer;
      transition: 0.3s;
    }
    .ai-fab:active { transform: scale(0.9); }
  </style>
</head>

<body class="max-w-md mx-auto">
  <header class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-black text-slate-800 tracking-tighter">
      ğŸ¼ HanjaPass <span class="text-orange-500">PRO</span>
    </h1>
    <span class="text-[10px] bg-yellow-400 px-2 py-1 rounded-full font-bold">é‡œå±±ç‰ˆæœ¬ 1.0</span>
  </header>

  <div id="levelBar" class="flex overflow-x-auto pb-4 no-scrollbar"></div>
  <div id="container"></div>

  <!-- AI Chat -->
  <div id="ai-window">
    <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="text-lg">ğŸ¤–</span>
        <span class="font-bold text-sm">AI í•œì ì„ ìƒë‹˜</span>
      </div>
      <button onclick="toggleAI()" class="text-xl">&times;</button>
    </div>

    <div id="ai-chat-body" class="flex-1 p-4 overflow-y-auto flex flex-col no-scrollbar bg-gray-50">
      <div class="msg-ai">ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤. ì§ˆë¬¸ì´ ìˆìœ¼ì‹ ê°€ìš”? ğŸ˜Š</div>
    </div>

    <div class="p-3 border-t bg-white flex gap-2">
      <input
        id="ai-input"
        type="text"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
        class="flex-1 border rounded-full px-4 py-2 text-sm focus:outline-none focus:border-orange-500"
      />
      <button
        id="ai-send-btn"
        onclick="askAI()"
        class="bg-orange-500 text-white w-10 h-10 rounded-full flex items-center justify-center font-bold"
        title="Send"
      >
        â†‘
      </button>
    </div>
  </div>

  <div class="ai-fab" onclick="toggleAI()">
    <span class="text-2xl">ğŸ¤–</span>
  </div>

  <script>
    let globalData = {};
    let currentLevel = "";

    // âœ… 1) ì—¬ê¸° KEYë§Œ ë³¸ì¸ ê²ƒìœ¼ë¡œ ë„£ìœ¼ë©´ ë©ë‹ˆë‹¤
    // âš ï¸ ì°¸ê³ : KEYë¥¼ í”„ë¡ íŠ¸ì— ì§ì ‘ ë„£ìœ¼ë©´ ë‚˜ì¤‘ì— ë‚¨ì´ ë³µì‚¬í•  ìˆ˜ ìˆì–´ìš”(ë°°í¬ìš©ì€ ì„œë²„ë¡œ ì˜®ê¸°ëŠ” ê²Œ ì•ˆì „)
    const GEMINI_KEY = "AIzaSyBgRz67t10Rvuy-4L4OwKkwKuA2XUhI_n4";

    // âœ… 2) ë‹¹ì‹ ì´ ì˜¬ë ¤ì¤€ ListModels JSONì— ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ëª¨ë¸ëª… ì‚¬ìš©
    // ê°€ì¥ ë¬´ë‚œ: models/gemini-flash-latest
    const GEMINI_MODEL = "gemini-flash-latest";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_KEY}`;

    // -------- App Init --------
    async function initApp() {
      try {
        // ìºì‹œ ë°©ì§€ìš© ëœë¤ ì¿¼ë¦¬
        const response = await fetch("data.json?t=" + Date.now());
        if (!response.ok) throw new Error("data.json fetch failed: " + response.status);
        globalData = await response.json();
        renderLevels();
      } catch (e) {
        console.error(e);
        document.getElementById("container").innerHTML = `
          <div class="text-center p-10 bg-red-50 rounded-3xl">
            <p class="text-red-500 font-bold">data.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-xs text-gray-500 mt-2">âœ… ê°™ì€ í´ë”ì— <b>data.json</b>ì´ ìˆëŠ”ì§€, ì´ë¦„ì´ ì •í™•í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
          </div>`;
      }

      // âœ… Enterë¡œ ë³´ë‚´ê¸°
      const input = document.getElementById("ai-input");
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") askAI();
      });
    }

    // -------- Level Bar --------
    function renderLevels() {
      const bar = document.getElementById("levelBar");
      bar.innerHTML = "";

      const levels = Object.keys(globalData || {});
      if (levels.length === 0) {
        document.getElementById("container").innerHTML = `
          <div class="text-center p-10 bg-yellow-50 rounded-3xl">
            <p class="text-yellow-700 font-bold">data.json ë‚´ìš©ì´ ë¹„ì–´ìˆê±°ë‚˜ í˜•ì‹ì´ ë‹¤ë¦…ë‹ˆë‹¤.</p>
          </div>`;
        return;
      }

      levels.forEach((level, index) => {
        const btn = document.createElement("button");
        btn.className = "level-btn flex-shrink-0";
        btn.innerText = level;
        btn.onclick = () => selectLevel(level);
        bar.appendChild(btn);
        if (index === 0) selectLevel(level);
      });
    }

    function selectLevel(level) {
      currentLevel = level;
      document.querySelectorAll(".level-btn").forEach((b) => {
        b.classList.toggle("active-level", b.innerText === level);
      });
      renderWords();
    }

    // -------- Word List --------
    function renderWords() {
      const list = document.getElementById("container");
      list.innerHTML = "";

      const levelObj = globalData[currentLevel];
      if (!levelObj) return;

      const categories = Object.keys(levelObj);
      if (categories.length === 0) return;

      const firstCategory = categories[0];
      const words = levelObj[firstCategory] || [];

      words.forEach((item) => {
        const card = document.createElement("div");
        card.className = "word-card";
        card.innerHTML = `
          <div class="text-orange-500 font-bold mb-2 text-lg">${escapeHtml(item.py || "")}</div>
          <div class="jelly-box" onclick="play('${escapeJs(item.cn || "")}')">
            <span class="text-6xl font-black text-slate-800">${escapeHtml(item.cn || "")}</span>
          </div>
          <div class="mt-4 text-2xl font-bold text-rose-500">${escapeHtml(item.trans || "")}</div>
        `;
        list.appendChild(card);
      });
    }

    // -------- TTS --------
    function play(text) {
      try {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = "zh-CN";
        window.speechSynthesis.speak(utter);
      } catch (e) {
        console.error("TTS Error:", e);
      }
    }

    // -------- AI Window Toggle --------
    function toggleAI() {
      const win = document.getElementById("ai-window");
      win.style.display = (win.style.display === "flex") ? "none" : "flex";
      if (win.style.display === "flex") {
        setTimeout(() => document.getElementById("ai-input").focus(), 50);
      }
    }

    // -------- AI Chat --------
    async function askAI() {
      const input = document.getElementById("ai-input");
      const sendBtn = document.getElementById("ai-send-btn");

      const msg = (input.value || "").trim();
      if (!msg) return;

      addMessage(msg, "user");
      input.value = "";

      // ë²„íŠ¼ ì ê¹ ë¹„í™œì„±í™”(ì—°íƒ€ ë°©ì§€)
      sendBtn.disabled = true;
      sendBtn.classList.add("opacity-60");

      const loadingMsg = addMessage("ìƒê° ì¤‘ì…ë‹ˆë‹¤... ğŸ¤”", "ai");

      try {
        const prompt =
          "ë„ˆëŠ” í•œêµ­ì¸ì—ê²Œ í•œìë¥¼ ê°€ë¥´ì¹˜ëŠ” HSK ì „ë¬¸ê°€ì•¼. " +
          "ì•„ì£¼ ì¹œì ˆí•˜ê³  ì‰½ê²Œ í•œêµ­ì–´ë¡œ ì„¤ëª…í•´ì¤˜. " +
          "ê°€ëŠ¥í•˜ë©´ ì˜ˆë¬¸ë„ 1ê°œ ë§Œë“¤ì–´ì¤˜.\n\n" +
          "ì§ˆë¬¸: " + msg;

        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            // (ì„ íƒ) ë„ˆë¬´ ê¸¸ê²Œ ë§í•˜ëŠ” ê±¸ ë§‰ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ë¥¼ ì¡°ì ˆ
            generationConfig: {
              temperature: 0.7,
              maxOutputTokens: 512
            }
          })
        });

        const data = await response.json();

        // API ìì²´ ì˜¤ë¥˜(í‚¤/ê¶Œí•œ/ëª¨ë¸ ë“±)
        if (data && data.error) {
          loadingMsg.innerText =
            "âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”:\n" +
            (data.error.message || "Unknown error") +
            "\n\nâœ… í™•ì¸í•  ê²ƒ:\n- ëª¨ë¸ëª…(gemini-flash-latest)\n- API Key ì œí•œ(ë„ë©”ì¸ ì œí•œ)\n- ê²°ì œ/ì¿¼í„°";
          console.error("Google Error:", data.error);
          return;
        }

        // ì •ìƒ ë‹µë³€ íŒŒì‹±(ë” ì•ˆì „í•˜ê²Œ)
        const reply =
          data?.candidates?.[0]?.content?.parts?.map((p) => p.text || "").join("") ||
          "ë‹µë³€ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¬ë¼ìš”)";

        loadingMsg.innerText = reply;

      } catch (e) {
        console.error("Fetch Error:", e);
        loadingMsg.innerText =
          "âŒ ì—°ê²° ì‹¤íŒ¨ì…ë‹ˆë‹¤.\n" +
          "âœ… í™•ì¸í•  ê²ƒ:\n- ì¸í„°ë„· ì—°ê²°\n- API Key ë„ë©”ì¸ ì œí•œ(Referrer)\n- ë¸Œë¼ìš°ì € ì½˜ì†”(Network íƒ­ì˜ ì˜¤ë¥˜ ë©”ì‹œì§€";
      } finally {
        sendBtn.disabled = false;
        sendBtn.classList.remove("opacity-60");
      }
    }

    function addMessage(text, role) {
      const body = document.getElementById("ai-chat-body");
      const div = document.createElement("div");
      div.className = role === "user" ? "msg-user" : "msg-ai";
      div.innerText = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
      return div;
    }

    // -------- Small helpers to avoid broken HTML/JS when data contains quotes --------
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function escapeJs(str) {
      // for onclick="play('...')"
      return String(str).replaceAll("\\", "\\\\").replaceAll("'", "\\'");
    }

    initApp();
  </script>
</body>
</html>



