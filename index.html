<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    .bubble { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>

<body class="p-4">

  <!-- æµ®åŠ¨æŒ‰é’® -->
  <button onclick="toggleAI()"
    class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
    ğŸ¤–
  </button>

  <!-- AI çª—å£ -->
  <div id="ai-panel"
    class="hidden fixed bottom-20 right-4 w-[340px] bg-white rounded-xl shadow-xl flex flex-col">

    <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
      <span>AI í•œì ì„ ìƒë‹˜</span>
      <button onclick="toggleAI()">âœ–</button>
    </div>

    <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

    <div class="p-3 border-t flex gap-2">
      <input id="input" class="flex-1 border rounded px-2 py-1"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" />
      <button id="sendBtn" onclick="send()"
        class="bg-orange-500 text-white px-3 py-1 rounded">
        ë³´ë‚´ê¸°
      </button>
    </div>

    <div id="hint" class="text-xs text-center text-gray-500 pb-2">
      ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel /api/gemini
    </div>
  </div>

<script>
  // âœ… ç»ˆæå…³é”®ï¼šæ— è®ºé¡µé¢è·‘åœ¨ GitHub Pages è¿˜æ˜¯åˆ«å¤„ï¼Œéƒ½å›ºå®šæ‰“åˆ° Vercel
  const API_URL = "https://hanjiapass.vercel.app/api/gemini";

  const panel = document.getElementById("ai-panel");
  const chat  = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const hint = document.getElementById("hint");

  function toggleAI() {
    panel.classList.toggle("hidden");
    if (!panel.classList.contains("hidden")) input.focus();
  }

  function addMsg(text, who) {
    const div = document.createElement("div");
    div.className = who === "user" ? "text-right" : "text-left text-gray-800";
    div.innerHTML = `
      <span class="bubble inline-block px-3 py-2 rounded-lg ${
        who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"
      }">${escapeHtml(text)}</span>
    `;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function send() {
    const msg = input.value.trim();
    if (!msg) return;

    addMsg(msg, "user");
    input.value = "";

    sendBtn.disabled = true;
    sendBtn.classList.add("opacity-60");

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // âœ… åç«¯ç»ˆæç‰ˆè¯»å–çš„æ˜¯ message
        body: JSON.stringify({ message: msg })
      });

      // âœ… å°±ç®—åç«¯ç‚¸äº†ï¼Œä¹Ÿå…ˆè¯»æˆ textï¼Œå†å°è¯• JSONï¼Œé¿å… DOCTYPE JSON é”™
      const raw = await res.text();
      let data = null;
      try { data = JSON.parse(raw); } catch (_) {}

      if (!res.ok) {
        const errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : raw;
        throw new Error(`HTTP ${res.status}: ${errMsg}`);
      }

      const answer = (data && data.text) ? data.text : "(ì‘ë‹µ ì—†ìŒ)";
      addMsg(answer, "ai");

    } catch (e) {
      addMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + e.message, "ai");
    } finally {
      sendBtn.disabled = false;
      sendBtn.classList.remove("opacity-60");
    }
  }

  // Enter å‘é€
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") send();
  });

  // åˆå§‹æ¬¢è¿
  addMsg("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š\nê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ì˜ˆë¬¸/ë¬¸ë²•/ë¹„ìŠ·í•œ í‘œí˜„ì„ ë¬¼ì–´ë³´ì„¸ìš”!", "ai");
  hint.textContent = `ğŸ” Key ë³´í˜¸ ëª¨ë“œ: ${API_URL}`;
</script>

</body>
</html>
