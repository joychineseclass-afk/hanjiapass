<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="p-4">

  <!-- Floating Button -->
  <button onclick="toggleAI()"
    class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
    ğŸ¤–
  </button>

  <!-- Panel -->
  <div id="ai-panel"
    class="hidden fixed bottom-20 right-4 w-[360px] bg-white rounded-xl shadow-xl flex flex-col">

    <!-- Header -->
    <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
      <span>AI í•œì ì„ ìƒë‹˜</span>
      <button onclick="toggleAI()">âœ–</button>
    </div>

    <!-- Controls -->
    <div class="px-3 pt-3 pb-2 border-b text-xs space-y-2">
      <div class="flex items-center gap-2">
        <input id="ttsEnabled" type="checkbox" class="accent-orange-500" checked />
        <label for="ttsEnabled" class="select-none">ì½ì–´ì£¼ê¸°(TTS)</label>
      </div>

      <div class="flex items-center gap-2">
        <span class="text-gray-600">ìŒìƒ‰</span>
        <select id="voiceSelect" class="flex-1 border rounded px-2 py-1 text-xs bg-white"></select>
      </div>

      <div class="text-[11px] text-gray-500 leading-snug">
        â€¢ AIëŠ” <b>HSK í•œì/ë¬¸ë²• ì„ ìƒë‹˜</b>ìœ¼ë¡œ ê³ ì •ë©ë‹ˆë‹¤.<br/>
        â€¢ ë‹µë³€ì€ <b>í•œêµ­ì–´</b> ì¤‘ì‹¬ + í•„ìš”í•œ ê²½ìš° <b>ì¤‘êµ­ì–´/ë³‘ìŒ</b>ì„ í•¨ê»˜ ì œê³µí•©ë‹ˆë‹¤.
      </div>
    </div>

    <!-- Chat -->
    <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

    <!-- Input -->
    <div class="p-3 border-t flex gap-2 items-center">
      <input id="input"
        class="flex-1 border rounded px-2 py-1"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" />
      <button id="sendBtn" onclick="send()"
        class="bg-orange-500 text-white px-3 py-1 rounded">
        ë³´ë‚´ê¸°
      </button>
    </div>

    <!-- Footer -->
    <div class="text-xs text-center text-gray-500 pb-2">
      ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel API
      <span id="statusDot" class="inline-block ml-2 w-2 h-2 rounded-full bg-gray-300 align-middle"></span>
      <span id="statusText" class="ml-1 text-[11px]">ëŒ€ê¸°</span>
    </div>
  </div>

<script>
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const statusDot = document.getElementById("statusDot");
const statusText = document.getElementById("statusText");
const ttsEnabled = document.getElementById("ttsEnabled");
const voiceSelect = document.getElementById("voiceSelect");

// âœ… åŒåŸŸä¼˜å…ˆï¼ˆæœ€ç¨³ï¼šä¸ä¼šå› ä¸ºåŸŸåã€CORSã€é¢„è§ˆåŸŸå˜åŒ–è€ŒæŒ‚ï¼‰
// å¦‚æœä½ éè¦å›ºå®šåŸŸåï¼Œä¹Ÿå¯ä»¥æŠŠ API_URL æ”¹æˆä½ é‚£æ¡ç»å¯¹åœ°å€ã€‚
const API_URL = (location.origin || "https://hanjiapass.vercel.app") + "/api/gemini";

// âœ… å›ºå®šè€å¸ˆäººè®¾ï¼ˆæ¯æ¬¡éƒ½ä¼šå¸¦ä¸Šï¼‰
const TEACHER_SYSTEM_PROMPT = `
ë‹¹ì‹ ì€ "AI í•œì ì„ ìƒë‹˜"ì…ë‹ˆë‹¤.
ëª©í‘œ: í•œêµ­ì¸ í•™ìŠµìì—ê²Œ HSK/í•œì/ë¬¸ë²•ì„ ì¹œì ˆí•˜ê³  ëª…í™•í•˜ê²Œ ì„¤ëª…í•©ë‹ˆë‹¤.
ê·œì¹™:
1) ê¸°ë³¸ì€ í•œêµ­ì–´ë¡œ ë‹µí•©ë‹ˆë‹¤.
2) í•„ìš”í•˜ë©´ ì¤‘êµ­ì–´ ì˜ˆë¬¸ + ë³‘ìŒ + í•œêµ­ì–´ í•´ì„ì„ í•¨ê»˜ ì œê³µí•©ë‹ˆë‹¤.
3) ì´ˆë³´ë„ ì´í•´í•˜ë„ë¡ ë‹¨ê³„ì ìœ¼ë¡œ ì„¤ëª…í•˜ê³ , ë§ˆì§€ë§‰ì— ì§§ì€ ì—°ìŠµë¬¸ì œ(1~2ê°œ)ë¥¼ ëƒ…ë‹ˆë‹¤.
4) ë§íˆ¬ëŠ” ë”°ëœ»í•˜ê³  ì„ ìƒë‹˜ì²˜ëŸ¼, ê³¼ì¥/í—ˆìœ„ì •ë³´ëŠ” í”¼í•©ë‹ˆë‹¤.
`;

// ----- UI helpers -----
function toggleAI() { panel.classList.toggle("hidden"); }

function setStatus(type, text) {
  // type: idle | loading | ok | error
  statusText.textContent = text || "";
  statusDot.className = "inline-block ml-2 w-2 h-2 rounded-full align-middle " + (
    type === "loading" ? "bg-orange-400" :
    type === "ok" ? "bg-green-500" :
    type === "error" ? "bg-red-500" : "bg-gray-300"
  );
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function addMsg(text, who) {
  const div = document.createElement("div");
  div.className = who === "user" ? "text-right" : "text-left text-gray-800";
  div.innerHTML = `
    <span class="inline-block px-3 py-2 rounded-lg ${who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"}">
      <pre>${escapeHtml(text)}</pre>
    </span>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  // âœ… AI å›å¤åæœ—è¯»
  if (who === "ai" && ttsEnabled.checked) speak(text);
}

// ----- TTS (Web Speech API) -----
let voices = [];
function loadVoices() {
  voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
  voiceSelect.innerHTML = "";

  // ä¼˜å…ˆéŸ©è¯­éŸ³è‰²
  const ko = voices.filter(v => (v.lang || "").toLowerCase().includes("ko"));
  const rest = voices.filter(v => !((v.lang || "").toLowerCase().includes("ko")));
  const list = [...ko, ...rest];

  list.forEach((v, idx) => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  });

  // å°½é‡è‡ªåŠ¨é€‰ä¸€ä¸ªéŸ©è¯­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  if (ko.length > 0) voiceSelect.value = ko[0].name;
}

function speak(text) {
  try {
    if (!window.speechSynthesis) return;
    speechSynthesis.cancel();

    const u = new SpeechSynthesisUtterance(text);
    const selected = voices.find(v => v.name === voiceSelect.value);
    if (selected) u.voice = selected;

    // ç¨å¾®è‡ªç„¶ä¸€ç‚¹
    u.rate = 1.0;
    u.pitch = 1.0;
    u.lang = selected?.lang || "ko-KR";

    speechSynthesis.speak(u);
  } catch (_) {}
}

if ("speechSynthesis" in window) {
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}

// Enter to send
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") send();
});

// ----- Main send -----
async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  addMsg(msg, "user");
  input.value = "";

  setStatus("loading", "ì‘ë‹µ ìƒì„± ì¤‘â€¦");
  sendBtn.disabled = true;
  sendBtn.classList.add("opacity-60", "cursor-not-allowed");

  // ä½ å¯ä»¥åœ¨è¿™é‡Œå†³å®šæ˜¯å¦æŠŠç”¨æˆ·è¾“å…¥ä¹Ÿåšä¸€æ¬¡â€œæ•™å­¦æ¨¡å¼åŒ…è£…â€
  // ä¾‹å¦‚ï¼šconst wrapped = `í•™ìƒ ì§ˆë¬¸: ${msg}\n\nìœ„ ê·œì¹™ëŒ€ë¡œ ë‹µí•´ì¤˜.`;
  const payload = {
    prompt: msg,
    system: TEACHER_SYSTEM_PROMPT
  };

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    // âœ… é˜²æ­¢â€œè¿”å› HTML å¯¼è‡´ json() å´©æºƒ -> ç™½å±â€
    const rawText = await res.text();
    let data = {};
    try { data = JSON.parse(rawText); } catch (_) { data = { error: rawText }; }

    if (!res.ok) {
      throw new Error((data && (data.error || data.message || JSON.stringify(data))) || ("HTTP " + res.status));
    }

    const answer =
      data.text ||
      data.output ||
      data.response ||
      (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text) ||
      "(ì‘ë‹µ ì—†ìŒ)";

    addMsg(answer, "ai");
    setStatus("ok", "ì™„ë£Œ");
  } catch (e) {
    addMsg("ì˜¤ë¥˜: " + (e.message || "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."), "ai");
    setStatus("error", "ì˜¤ë¥˜");
  } finally {
    sendBtn.disabled = false;
    sendBtn.classList.remove("opacity-60", "cursor-not-allowed");
    setTimeout(() => setStatus("idle", "ëŒ€ê¸°"), 1200);
  }
}

// Init greeting
addMsg("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š\nê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ë¬¸ë²•ì„ ë¬¼ì–´ë³´ì„¸ìš”!", "ai");
setStatus("idle", "ëŒ€ê¸°");
</script>

</body>
</html>
