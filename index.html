<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="p-4">

  <button onclick="toggleAI()"
    class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
    ğŸ¤–
  </button>

  <div id="ai-panel"
    class="hidden fixed bottom-20 right-4 w-[360px] bg-white rounded-xl shadow-xl flex flex-col">

    <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
      <span>AI í•œì ì„ ìƒë‹˜</span>
      <button onclick="toggleAI()">âœ–</button>
    </div>

    <!-- âœ… TTS æ§åˆ¶åŒºï¼ˆå¼€å…³ + éŸ³è‰²é€‰æ‹©ï¼‰ -->
    <div class="px-3 pt-3 pb-2 border-b text-xs space-y-2">
      <div class="flex items-center gap-2">
        <input id="ttsToggle" type="checkbox" class="accent-orange-500" checked />
        <label for="ttsToggle" class="select-none">ì½ì–´ì£¼ê¸°(TTS)</label>
      </div>

      <div class="flex items-center gap-2">
        <span class="text-gray-600">ìŒìƒ‰(ì„ íƒ)</span>
        <select id="voiceSelect" class="flex-1 border rounded px-2 py-1 text-xs bg-white"></select>
      </div>

      <div class="text-[11px] text-gray-500 leading-snug">
        â€¢ ì¤‘êµ­ì–´(í•œì)ëŠ” ë°˜ë“œì‹œ ì½ì–´ì¤˜ìš”. (ë°œìŒ í•™ìŠµìš©)<br/>
        â€¢ ê¸°í˜¸/êµ¬ë‘ì ì€ ì½ì§€ ì•Šë„ë¡ ì²˜ë¦¬í–ˆì–´ìš”.
      </div>
    </div>

    <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

    <div class="p-3 border-t flex gap-2 items-center">
      <input id="input"
        class="flex-1 border rounded px-2 py-2"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦"
        onkeydown="if(event.key==='Enter') send();" />
      <button onclick="send()"
        class="bg-orange-500 text-white px-4 py-2 rounded">
        ë³´ë‚´ê¸°
      </button>
    </div>

    <div class="text-xs text-center text-gray-500 pb-2">
      ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel API
    </div>
  </div>

<script>
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");
const ttsToggle = document.getElementById("ttsToggle");
const voiceSelect = document.getElementById("voiceSelect");

// âœ… ä½ æ˜¨å¤©è·‘é€šçš„ç»å¯¹åœ°å€ï¼ˆä¿æŒä¸åŠ¨ï¼‰
const API_URL = "https://hanjiapass.vercel.app/api/gemini";

function toggleAI() {
  panel.classList.toggle("hidden");
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function addMsg(text, who) {
  const div = document.createElement("div");
  div.className = who === "user" ? "text-right" : "text-left text-gray-800";
  div.innerHTML = `
    <span class="inline-block px-3 py-2 rounded-lg ${who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"}">
      <pre>${escapeHtml(text)}</pre>
    </span>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  // âœ… AI å›å¤åè‡ªåŠ¨æœ—è¯»ï¼ˆå¯å…³é—­ï¼‰
  if (who === "ai") {
    speakMultilang(text);
  }
}

/* =========================================================
   âœ… å¤šè¯­åˆ†æ®µæœ—è¯»ï¼šä¸­æ–‡ä¸€å®šè¯»ï¼ŒéŸ©è¯­ä¹Ÿè¯»ï¼›ä¸è¯»æ ‡ç‚¹/ç¬¦å·
========================================================= */

// è¯­éŸ³åº“
let VOICES = [];
function loadVoices() {
  if (!("speechSynthesis" in window)) return;
  VOICES = speechSynthesis.getVoices() || [];

  // å¡«å……ä¸‹æ‹‰æ¡†ï¼ˆæ˜¾ç¤ºæ‰€æœ‰éŸ³è‰²ï¼‰
  voiceSelect.innerHTML = "";
  VOICES.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSelect.appendChild(opt);
  });

  // é»˜è®¤é€‰ä¸€ä¸ªéŸ©è¯­éŸ³è‰²ï¼ˆæ›´åƒè€å¸ˆï¼‰
  const defaultKo = VOICES.find(v => (v.lang || "").toLowerCase().startsWith("ko"));
  if (defaultKo) voiceSelect.value = defaultKo.name;
}
if ("speechSynthesis" in window) {
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}

// âœ… æ¸…æ´—ï¼šå»æ ‡ç‚¹/ç¬¦å·ï¼Œä½†ä¿ç•™ä¸­æ–‡/éŸ©è¯­/è‹±æ–‡
function ttsCleanKeepText(text) {
  if (!text) return "";
  let t = String(text);

  // å»ä»£ç å—
  t = t.replace(/```[\s\S]*?```/g, " ");

  // å» markdown ç¬¦å·
  t = t.replace(/[*_`#>|[\]]/g, " ");
  t = t.replace(/-{2,}/g, " ");

  // æ ‡ç‚¹æ›¿æ¢ä¸ºç©ºæ ¼ï¼ˆé¿å…è¯»â€œé€—å·å¥å·â€ï¼‰
  t = t.replace(/[ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼šã€â€œâ€â€˜â€™ï¼ˆï¼‰()\[\]{}ã€Šã€‹ã€ˆã€‰â€¦Â·ã€.,!?;:"'()]/g, " ");

  // å» emoji / ç‰¹æ®Šç¬¦å·
  t = t.replace(/[\u{1F300}-\u{1FAFF}]/gu, " ");

  // å‹ç¼©ç©ºæ ¼
  t = t.replace(/\s+/g, " ").trim();
  return t;
}

// è¯†åˆ«è¯­è¨€ï¼šå«ä¸­æ–‡â†’zhï¼›å«éŸ©è¯­â†’koï¼›å¦åˆ™ en
function detectLang(chunk) {
  const hasZh = /[\u4E00-\u9FFF]/.test(chunk);
  const hasKo = /[\uAC00-\uD7A3]/.test(chunk);
  if (hasZh) return "zh-CN";
  if (hasKo) return "ko-KR";
  return "en-US";
}

// åˆ†æ®µï¼šæŒ‰è¯­ç§åˆå¹¶
function splitByLang(text) {
  const cleaned = ttsCleanKeepText(text);
  if (!cleaned) return [];

  // å…ˆæŒ‰æ¢è¡Œåˆ‡ï¼Œå†æŒ‰å¥å­ç©ºæ ¼è½»åˆ‡ï¼ˆå¤Ÿç”¨ä¸”ç¨³å®šï¼‰
  const rough = cleaned
    .split(/\n+/)
    .flatMap(line => line.split(/(?<=[.?!])\s+|\s{2,}/g))
    .map(s => s.trim())
    .filter(Boolean);

  const parts = [];
  for (const piece of rough) {
    const lang = detectLang(piece);
    const last = parts[parts.length - 1];
    if (last && last.lang === lang) {
      last.text += " " + piece;
    } else {
      parts.push({ lang, text: piece });
    }
  }
  return parts;
}

// é€‰éŸ³è‰²ï¼šä¼˜å…ˆå¯¹åº”è¯­è¨€ï¼›å¦‚æœç”¨æˆ·ä¸‹æ‹‰é€‰äº†æŸä¸ªéŸ³è‰²ï¼Œå°±ä½œä¸ºâ€œå…¨å±€åå¥½â€
function pickVoice(lang) {
  if (!VOICES.length) return null;

  // ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©ä¼˜å…ˆï¼ˆä¸ç®¡è¯­è¨€ï¼‰
  const selectedName = voiceSelect.value;
  const userSelected = VOICES.find(v => v.name === selectedName);
  if (userSelected) return userSelected;

  // å¦åˆ™æŒ‰è¯­è¨€è‡ªåŠ¨é€‰
  const v1 = VOICES.find(v => (v.lang || "").toLowerCase().startsWith(lang.toLowerCase()));
  if (v1) return v1;
  const v2 = VOICES.find(v => (v.lang || "").toLowerCase().includes(lang.toLowerCase()));
  if (v2) return v2;

  return VOICES[0];
}

// æ ¸å¿ƒæœ—è¯»ï¼šåˆ†æ®µé¡ºåºæ’­æ”¾ï¼ˆPromise ä¸²èµ·æ¥ï¼‰
async function speakMultilang(rawText) {
  if (!ttsToggle.checked) return;
  if (!("speechSynthesis" in window)) return;

  const parts = splitByLang(rawText);
  if (!parts.length) return;

  speechSynthesis.cancel();

  for (const p of parts) {
    await new Promise((resolve) => {
      const u = new SpeechSynthesisUtterance(p.text);

      // âœ… æ›´åœ†æ¶¦å¯çˆ±ä¸€ç‚¹ï¼ˆä½ è¦çš„ï¼‰
      u.rate = 0.95;   // ç¨æ…¢
      u.pitch = 1.10;  // ç¨é«˜ä¸€ç‚¹ç‚¹
      u.volume = 1.0;

      u.lang = p.lang;
      const voice = pickVoice(p.lang);
      if (voice) u.voice = voice;

      u.onend = resolve;
      u.onerror = resolve;

      speechSynthesis.speak(u);
    });
  }
}

/* =========================================================
   âœ… å‘é€æ¶ˆæ¯
========================================================= */
async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  addMsg(msg, "user");
  input.value = "";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: msg })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      throw new Error((data && (data.error || JSON.stringify(data))) || ("HTTP " + res.status));
    }

    addMsg(data.text || "(ì‘ë‹µ ì—†ìŒ)", "ai");
  } catch (e) {
    addMsg("ì˜¤ë¥˜: " + (e.message || "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."), "ai");
  }
}

// åˆå§‹æ¬¢è¿
addMsg("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š\nê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ë¬¸ë²•ì„ ë¬¼ì–´ë³´ì„¸ìš”!", "ai");
</script>

</body>
</html>
