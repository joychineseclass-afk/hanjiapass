<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI í•œì ì„ ìƒë‹˜ Â· HanjaPass</title>

  <!-- âœ… Tailwind CDN (ê°œë°œ/ë°ëª¨ìš©). ìš´ì˜ì´ë©´ ë¹Œë“œ ê¶Œì¥ -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ì‘ì€ UI ë³´ì • */
    .card-hover { transition: transform .12s ease, box-shadow .12s ease; }
    .card-hover:hover { transform: translateY(-2px); }
    .chip { border: 1px solid rgba(0,0,0,.08); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.08); }
    .fade-in { animation: fadeIn .15s ease-out; }
    @keyframes fadeIn { from { opacity: .4; transform: translateY(2px);} to { opacity: 1; transform: translateY(0);} }
    .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(0,0,0,.15); border-radius: 999px; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-slate-900 text-white grid place-items-center">å­—</div>
      <div class="flex-1">
        <h1 class="text-lg font-bold leading-tight">HanjaPass Â· AI í•œì ì„ ìƒë‹˜</h1>
        <p class="text-xs text-slate-500">í´ë¦­í•˜ë©´ HSK/ë¶€ìˆ˜/íšìˆ˜ ì •ë³´ë¥¼ ë³´ì—¬ì£¼ê³ , ì§ˆë¬¸ë„ í•  ìˆ˜ ìˆì–´ìš”.</p>
      </div>
      <a class="text-xs text-slate-500 hover:text-slate-700" href="#" onclick="openHelp(); return false;">ë„ì›€ë§</a>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div id="topAlert" class="hidden mb-4 p-3 rounded-xl border bg-white text-sm"></div>

    <div class="grid grid-cols-12 gap-4">
      <!-- Left: levels -->
      <aside class="col-span-12 md:col-span-3">
        <div class="bg-white rounded-2xl border shadow-soft p-3">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-sm font-semibold">ë ˆë²¨</span>
            <span id="levelCount" class="text-xs text-slate-500"></span>
          </div>

          <div class="flex gap-2 mb-3">
            <input id="searchInput" class="w-full text-sm px-3 py-2 rounded-xl border focus:outline-none focus:ring"
                   placeholder="ê²€ìƒ‰: í•œì/ëœ»/ë³‘ìŒ/ë‹¨ì–´..." />
            <button class="px-3 py-2 rounded-xl border text-sm hover:bg-slate-50" onclick="clearSearch()">X</button>
          </div>

          <div id="levelList" class="space-y-1 max-h-[70vh] overflow-auto scrollbar-thin pr-1"></div>
        </div>
      </aside>

      <!-- Right: content -->
      <section class="col-span-12 md:col-span-9">
        <div class="bg-white rounded-2xl border shadow-soft p-4">
          <div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
            <div class="flex-1">
              <h2 id="currentTitle" class="text-base font-bold">ëª©ë¡</h2>
              <p id="currentSubtitle" class="text-sm text-slate-500">ì™¼ìª½ì—ì„œ ë ˆë²¨ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            </div>

            <div class="flex items-center gap-2">
              <button class="px-3 py-2 rounded-xl border text-sm hover:bg-slate-50" onclick="toggleView()">
                ë³´ê¸°: <span id="viewModeLabel" class="font-semibold">ì¹´ë“œ</span>
              </button>
              <button class="px-3 py-2 rounded-xl border text-sm hover:bg-slate-50" onclick="randomPick()">
                ëœë¤ ğŸ²
              </button>
            </div>
          </div>

          <div class="grid grid-cols-12 gap-4">
            <!-- List -->
            <div class="col-span-12 lg:col-span-7">
              <div id="itemsWrap" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
              <div id="emptyState" class="hidden text-center text-slate-500 py-10">
                ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”.
              </div>
            </div>

            <!-- Detail -->
            <div class="col-span-12 lg:col-span-5">
              <div class="rounded-2xl border bg-slate-50 p-4">
                <div class="flex items-start gap-3">
                  <div id="detailChar" class="w-16 h-16 rounded-2xl bg-white border grid place-items-center text-3xl font-bold">å­—</div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span id="detailWord" class="text-base font-bold">ì„ íƒí•œ í•­ëª©</span>
                      <span id="detailHSK" class="chip text-xs px-2 py-1 rounded-full bg-white">HSK: -</span>
                      <span id="detailRadical" class="chip text-xs px-2 py-1 rounded-full bg-white">ë¶€ìˆ˜: -</span>
                      <span id="detailStrokes" class="chip text-xs px-2 py-1 rounded-full bg-white">íšìˆ˜: -</span>
                    </div>
                    <p id="detailMeaning" class="text-sm text-slate-600 mt-1">ì™¼ìª½ ëª©ë¡ì—ì„œ í•˜ë‚˜ë¥¼ í´ë¦­í•´ ë³´ì„¸ìš”.</p>
                    <p id="detailExtra" class="text-xs text-slate-500 mt-2"></p>
                  </div>
                </div>

                <div class="mt-4">
                  <div class="text-sm font-semibold mb-2">ìëª¨(ë¬¸ì) ë¶„ì„</div>
                  <div id="charBreakdown" class="space-y-2"></div>
                  <p class="text-xs text-slate-500 mt-2">
                    â€» ì—¬ëŸ¬ ê¸€ì(ë‹¨ì–´)ë¼ë©´, ê° ê¸€ìë³„ë¡œ HSK/ë¶€ìˆ˜/íšìˆ˜ë¥¼ ë”°ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                  </p>
                </div>

                <hr class="my-4 border-slate-200" />

                <div class="text-sm font-semibold mb-2">AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°</div>
                <p class="text-xs text-slate-500 mb-3">
                  ì˜ˆ: â€œì´ ê¸€ì HSK ëª‡ ê¸‰ì´ì•¼?â€, â€œì´ˆë“±í•™ìƒì—ê²Œ ì‰¬ìš´ ì˜ˆë¬¸ ë§Œë“¤ì–´ì¤˜â€
                </p>

                <div class="flex gap-2">
                  <input id="quickQuestion" class="flex-1 text-sm px-3 py-2 rounded-xl border focus:outline-none focus:ring"
                         placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." />
                  <button id="quickAskBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm hover:opacity-90"
                          onclick="quickAsk()">ì§ˆë¬¸</button>
                </div>

                <div class="mt-3 text-xs text-slate-500">
                  âœ… Key ë³´í˜¸ ëª¨ë“œ: ê¸°ë³¸ì€ <span class="mono">/api/gemini</span> í˜¸ì¶œ (í”„ë¡ íŠ¸ì— Key ì—†ìŒ) <br/>
                  âš ï¸ ì„ì‹œë¡œ í”„ë¡ íŠ¸ Keyë¥¼ ì“°ë ¤ë©´ ì•„ë˜ <span class="mono">GEMINI_KEY</span>ì— ë„£ì–´ë„ ë©ë‹ˆë‹¤(ì¶”ì²œ X).
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </main>

  <!-- Floating AI widget -->
  <button class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-slate-900 text-white shadow-soft grid place-items-center"
          onclick="toggleAI()" aria-label="AI Chat">
    ğŸ¤–
  </button>

  <div id="aiPanel" class="hidden fixed bottom-24 right-6 w-[340px] max-w-[90vw] bg-white rounded-2xl border shadow-soft overflow-hidden fade-in">
    <div class="px-4 py-3 bg-slate-900 text-white flex items-center justify-between">
      <div class="font-semibold">AI í•œì ì„ ìƒë‹˜</div>
      <button class="opacity-90 hover:opacity-100" onclick="toggleAI()">âœ•</button>
    </div>

    <div id="aiMessages" class="h-[340px] overflow-auto p-3 space-y-2 bg-slate-50 scrollbar-thin"></div>

    <div class="p-3 bg-white border-t">
      <div class="flex gap-2">
        <input id="aiInput" class="flex-1 text-sm px-3 py-2 rounded-xl border focus:outline-none focus:ring"
               placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." />
        <button id="aiSendBtn" class="px-3 py-2 rounded-xl bg-orange-500 text-white text-sm hover:opacity-90"
                onclick="askAI()">ë³´ë‚´ê¸°</button>
      </div>
      <div class="mt-2 text-[11px] text-slate-500">
        ìš´ì˜ ê¶Œì¥: Vercel ì„œë²„ë¦¬ìŠ¤(<span class="mono">/api/gemini</span>)ë¡œ Key ë³´í˜¸
      </div>
    </div>
  </div>

  <!-- Help modal -->
  <div id="helpModal" class="hidden fixed inset-0 bg-black/40 z-40" onclick="closeHelp()">
    <div class="max-w-2xl mx-auto mt-16 px-4" onclick="event.stopPropagation()">
      <div class="bg-white rounded-2xl shadow-soft border overflow-hidden">
        <div class="px-4 py-3 bg-slate-900 text-white flex items-center justify-between">
          <div class="font-semibold">ë„ì›€ë§</div>
          <button onclick="closeHelp()">âœ•</button>
        </div>
        <div class="p-4 text-sm text-slate-700 space-y-3">
          <p><b>1)</b> ì´ í˜ì´ì§€ëŠ” ê°™ì€ í´ë”ì˜ <span class="mono">data.json</span>ì„ ì½ì–´ì„œ ë ˆë²¨/ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.</p>
          <p><b>2)</b> í•œì/ë‹¨ì–´ë¥¼ í´ë¦­í•˜ë©´ <b>HSK/ë¶€ìˆ˜/íšìˆ˜</b>ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</p>
          <p><b>3)</b> AI ì§ˆë¬¸ ê¸°ëŠ¥ì€ ê¸°ë³¸ì ìœ¼ë¡œ <span class="mono">/api/gemini</span>ë¡œ ìš”ì²­í•©ë‹ˆë‹¤(í”„ë¡ íŠ¸ì— Key ì—†ìŒ).</p>
          <p class="text-xs text-slate-500">
            * ì•„ì§ ì„œë²„ê°€ ì—†ìœ¼ë©´ ì„ì‹œë¡œ ì•„ë˜ ì½”ë“œì˜ <span class="mono">GEMINI_KEY</span>ì— Keyë¥¼ ë„£ì–´ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆì§€ë§Œ,
            GitHub Pages ê³µê°œ ì‚¬ì´íŠ¸ì—ì„œëŠ” Key ë…¸ì¶œ ìœ„í—˜ì´ ìˆì–´ìš”.
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   0) (ì¤‘ìš”) API ì„¤ì •
   - ìš´ì˜(ì¶”ì²œ): Vercel ì„œë²„ë¦¬ìŠ¤ /api/gemini ì‚¬ìš© â†’ í”„ë¡ íŠ¸ì— Key ì—†ìŒ
   - ì„ì‹œ(ë¹„ì¶”ì²œ): GEMINI_KEYì— ì§ì ‘ ë„£ìœ¼ë©´ í”„ë¡ íŠ¸ì—ì„œ Google API í˜¸ì¶œ
========================================================= */

// âœ… ìš´ì˜ ì¶”ì²œ: ì•„ë˜ëŠ” ë¹ˆ ê°’ìœ¼ë¡œ ë‘ì„¸ìš”. (Key ë…¸ì¶œ ë°©ì§€)
const GEMINI_KEY = ""; // â† ì„ì‹œ í…ŒìŠ¤íŠ¸ë§Œ ì‚¬ìš©í•  ê²ƒ (ì˜ˆ: "AIzaSy...")
const GEMINI_MODEL = "gemini-flash-latest";

// âœ… ìš´ì˜ ëª¨ë“œ: Vercel ë“±ì— ë§Œë“¤ /api/gemini ì—”ë“œí¬ì¸íŠ¸
const PROXY_API_URL = "/api/gemini";

/* =========================================================
   1) HSK/ë¶€ìˆ˜/íšìˆ˜ ë©”íƒ€ë°ì´í„°
   - ì—¬ê¸°ì— ìì£¼ ì“°ëŠ” ê¸€ìë¶€í„° ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.
   - ì˜ˆ: "ä½ ": { hsk:"1", radical:"äº»", strokes:7 }
========================================================= */
const HANZI_META = {
  "ä½ ": { hsk: "1", radical: "äº»", strokes: 7 },
  "å¥½": { hsk: "1", radical: "å¥³", strokes: 6 },
  "å­¦": { hsk: "1", radical: "å­", strokes: 8 },
  "ä¹ ": { hsk: "1", radical: "ä¹™", strokes: 3 },
  "æ±‰": { hsk: "2", radical: "æ°µ", strokes: 5 },
  "è¯­": { hsk: "1", radical: "è® ", strokes: 9 },
  "å­—": { hsk: "1", radical: "å­", strokes: 6 }
};

// (ì„ íƒ) HSK ë¼ë²¨ì„ ì˜ˆì˜ê²Œ
function prettyHSK(v) {
  if (!v) return "-";
  return String(v).startsWith("HSK") ? v : ("HSK " + v);
}

/* =========================================================
   2) ì•± ë°ì´í„° ë¡œë”© (data.json)
========================================================= */
let globalData = null;       // ì „ì²´ data.json
let levelKeys = [];          // ë ˆë²¨ ëª©ë¡
let currentLevel = null;     // í˜„ì¬ ë ˆë²¨ í‚¤
let currentItems = [];       // í˜„ì¬ ë ˆë²¨ ì•„ì´í…œ ëª©ë¡
let viewMode = "card";       // card | list
let selectedItem = null;     // ì„ íƒëœ ì•„ì´í…œ

function showAlert(msg, type="info") {
  const el = document.getElementById("topAlert");
  el.classList.remove("hidden");
  el.className = "mb-4 p-3 rounded-xl border bg-white text-sm";
  if (type === "error") el.classList.add("border-red-200","bg-red-50","text-red-700");
  if (type === "ok") el.classList.add("border-emerald-200","bg-emerald-50","text-emerald-700");
  if (type === "info") el.classList.add("border-slate-200","bg-white","text-slate-700");
  el.textContent = msg;
}

function clearAlert() {
  const el = document.getElementById("topAlert");
  el.classList.add("hidden");
  el.textContent = "";
}

async function initApp() {
  try {
    clearAlert();
    const res = await fetch("data.json?t=" + Date.now());
    if (!res.ok) throw new Error("data.json fetch failed: " + res.status);
    globalData = await res.json();

    // data.json êµ¬ì¡°ê°€ ë‹¤ì–‘í•  ìˆ˜ ìˆìœ¼ë‹ˆ ìµœëŒ€í•œ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬
    // 1) { levels: {...} } or 2) { ...ë ˆë²¨í‚¤... } í˜•íƒœ ì§€ì›
    const levelsObj = globalData.levels ? globalData.levels : globalData;
    if (!levelsObj || typeof levelsObj !== "object") throw new Error("data.json êµ¬ì¡°ë¥¼ ì½ì„ ìˆ˜ ì—†ì–´ìš”.");

    levelKeys = Object.keys(levelsObj);
    levelKeys.sort((a,b)=> String(a).localeCompare(String(b), "ko"));

    document.getElementById("levelCount").textContent = `(${levelKeys.length})`;

    renderLevelList(levelsObj);

    // ì²« ë ˆë²¨ ìë™ ì„ íƒ
    if (levelKeys.length) {
      selectLevel(levelKeys[0]);
    }

    // ê²€ìƒ‰ ì´ë²¤íŠ¸
    document.getElementById("searchInput").addEventListener("input", () => applyFilter());

    // ì—”í„°ë¡œ AI ë³´ë‚´ê¸°
    document.getElementById("aiInput").addEventListener("keydown", (e) => {
      if (e.key === "Enter") askAI();
    });
    document.getElementById("quickQuestion").addEventListener("keydown", (e) => {
      if (e.key === "Enter") quickAsk();
    });

  } catch (e) {
    console.error(e);
    showAlert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + e.message, "error");
  }
}

function renderLevelList(levelsObj) {
  const wrap = document.getElementById("levelList");
  wrap.innerHTML = "";
  levelKeys.forEach((k) => {
    const btn = document.createElement("button");
    btn.className = "w-full text-left px-3 py-2 rounded-xl hover:bg-slate-50 border border-transparent";
    btn.innerHTML = `
      <div class="flex items-center justify-between">
        <span class="text-sm font-semibold">${escapeHtml(k)}</span>
        <span class="text-xs text-slate-500">${countLevelItems(levelsObj[k])}</span>
      </div>
    `;
    btn.onclick = () => selectLevel(k);
    btn.id = "levelBtn_" + k;
    wrap.appendChild(btn);
  });
}

function countLevelItems(levelVal) {
  // levelValì´ ë°°ì—´ì¼ ìˆ˜ë„, ê°ì²´ì¼ ìˆ˜ë„ ìˆìŒ
  if (Array.isArray(levelVal)) return levelVal.length;
  if (levelVal && Array.isArray(levelVal.items)) return levelVal.items.length;
  if (levelVal && typeof levelVal === "object") return Object.keys(levelVal).length;
  return 0;
}

function selectLevel(levelKey) {
  const levelsObj = globalData.levels ? globalData.levels : globalData;
  currentLevel = levelKey;

  // ë²„íŠ¼ ìŠ¤íƒ€ì¼
  levelKeys.forEach(k => {
    const btn = document.getElementById("levelBtn_" + k);
    if (!btn) return;
    btn.classList.toggle("bg-slate-900", k === levelKey);
    btn.classList.toggle("text-white", k === levelKey);
    btn.classList.toggle("border-slate-900", k === levelKey);
    btn.classList.toggle("hover:bg-slate-50", k !== levelKey);
  });

  // í˜„ì¬ ë ˆë²¨ ì•„ì´í…œ íŒŒì‹±
  const levelVal = levelsObj[levelKey];
  currentItems = normalizeItems(levelVal);

  document.getElementById("currentTitle").textContent = String(levelKey);
  document.getElementById("currentSubtitle").textContent = `ì´ ${currentItems.length}ê°œ`;

  applyFilter();
}

function normalizeItems(levelVal) {
  // ë‹¤ì–‘í•œ êµ¬ì¡° ëŒ€ì‘:
  // - [ {hanja:"ä½ ", ...}, ... ]
  // - { items:[...] }
  // - { "ä½ ": {...}, "å¥½": {...} } â†’ ê°ì²´ë©´ keyë¥¼ wordë¡œ ë§Œë“¤ê¸°
  if (Array.isArray(levelVal)) return levelVal;
  if (levelVal && Array.isArray(levelVal.items)) return levelVal.items;

  if (levelVal && typeof levelVal === "object") {
    const arr = [];
    for (const [k,v] of Object.entries(levelVal)) {
      if (typeof v === "object") arr.push({ word: k, ...v });
      else arr.push({ word: k, value: v });
    }
    return arr;
  }
  return [];
}

function applyFilter() {
  const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();

  let filtered = currentItems;
  if (q) {
    filtered = currentItems.filter(it => {
      const blob = JSON.stringify(it).toLowerCase();
      return blob.includes(q);
    });
  }

  renderItems(filtered);
}

function clearSearch() {
  document.getElementById("searchInput").value = "";
  applyFilter();
}

function toggleView() {
  viewMode = (viewMode === "card") ? "list" : "card";
  document.getElementById("viewModeLabel").textContent = (viewMode === "card") ? "ì¹´ë“œ" : "ë¦¬ìŠ¤íŠ¸";
  applyFilter();
}

function randomPick() {
  if (!currentItems.length) return;
  const it = currentItems[Math.floor(Math.random() * currentItems.length)];
  selectItem(it);
  // ìŠ¤í¬ë¡¤ ìƒë‹¨ìœ¼ë¡œ
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function renderItems(items) {
  const wrap = document.getElementById("itemsWrap");
  const empty = document.getElementById("emptyState");
  wrap.innerHTML = "";

  if (!items.length) {
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");

  // ë³´ê¸° ëª¨ë“œì— ë”°ë¼ ìŠ¤íƒ€ì¼ ë³€ê²½
  if (viewMode === "list") {
    wrap.className = "space-y-2";
  } else {
    wrap.className = "grid grid-cols-1 sm:grid-cols-2 gap-3";
  }

  items.forEach((it) => {
    const card = document.createElement("button");
    card.className = (viewMode === "list")
      ? "w-full text-left p-3 rounded-2xl border bg-white hover:bg-slate-50 card-hover"
      : "w-full text-left p-3 rounded-2xl border bg-white card-hover";

    const word = (it.word || it.hanja || it.char || it.text || "").toString();
    const meaning = (it.meaning_ko || it.meaning || it.kr || it.korean || it.gloss || "").toString();
    const pinyin = (it.pinyin || it.py || "").toString();
    const hsk = (it.hsk || "").toString();

    const primaryChar = extractFirstHanzi(word) || word || "å­—";

    card.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="w-12 h-12 rounded-xl bg-slate-50 border grid place-items-center text-2xl font-bold">${escapeHtml(primaryChar)}</div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <div class="font-bold">${escapeHtml(word || primaryChar)}</div>
            <span class="chip text-xs px-2 py-1 rounded-full bg-white">HSK: ${escapeHtml(hsk || "-")}</span>
          </div>
          <div class="text-sm text-slate-600 truncate">${escapeHtml(meaning || "")}</div>
          <div class="text-xs text-slate-500 mt-1">${escapeHtml(pinyin || "")}</div>
        </div>
      </div>
    `;

    card.onclick = () => selectItem(it);
    wrap.appendChild(card);
  });
}

function selectItem(it) {
  selectedItem = it;

  const word = (it.word || it.hanja || it.char || it.text || "").toString();
  const meaning = (it.meaning_ko || it.meaning || it.kr || it.korean || it.gloss || "").toString();
  const pinyin = (it.pinyin || it.py || "").toString();

  const chars = extractHanziChars(word);
  const firstChar = chars[0] || extractFirstHanzi(word) || word || "å­—";

  document.getElementById("detailChar").textContent = firstChar;
  document.getElementById("detailWord").textContent = word || firstChar;
  document.getElementById("detailMeaning").textContent = meaning || "â€”";
  document.getElementById("detailExtra").textContent = pinyin ? ("Pinyin: " + pinyin) : "";

  // ë‹¨ì–´ ì „ì²´ì— ëŒ€í•œ â€œëŒ€í‘œâ€ ë©”íƒ€ëŠ” ì²« ê¸€ì ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
  const meta = HANZI_META[firstChar] || null;
  document.getElementById("detailHSK").textContent = "HSK: " + (meta ? prettyHSK(meta.hsk) : "-");
  document.getElementById("detailRadical").textContent = "ë¶€ìˆ˜: " + (meta ? meta.radical : "-");
  document.getElementById("detailStrokes").textContent = "íšìˆ˜: " + (meta ? meta.strokes : "-");

  // ê¸€ìë³„ ë¶„ì„
  renderBreakdown(chars.length ? chars : [firstChar]);
}

function renderBreakdown(chars) {
  const wrap = document.getElementById("charBreakdown");
  wrap.innerHTML = "";

  chars.forEach(ch => {
    const meta = HANZI_META[ch];
    const row = document.createElement("div");
    row.className = "p-3 rounded-2xl border bg-white";
    row.innerHTML = `
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-slate-50 border grid place-items-center text-xl font-bold">${escapeHtml(ch)}</div>
        <div class="flex-1">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="chip text-xs px-2 py-1 rounded-full bg-white">HSK: ${escapeHtml(meta ? prettyHSK(meta.hsk) : "-")}</span>
            <span class="chip text-xs px-2 py-1 rounded-full bg-white">ë¶€ìˆ˜: ${escapeHtml(meta ? meta.radical : "-")}</span>
            <span class="chip text-xs px-2 py-1 rounded-full bg-white">íšìˆ˜: ${escapeHtml(meta ? meta.strokes : "-")}</span>
          </div>
          <div class="text-xs text-slate-500 mt-1">
            ${meta ? "ë“±ë¡ë¨" : "ë¯¸ë“±ë¡ (HANZI_METAì— ì¶”ê°€í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤)"}
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(row);
  });
}

/* =========================================================
   3) AI Chat
   - ê¸°ë³¸: /api/gemini (Key ë³´í˜¸)
   - ì„ì‹œ: GEMINI_KEYê°€ ìˆìœ¼ë©´ ì§ì ‘ Google endpoint í˜¸ì¶œ
========================================================= */
function toggleAI() {
  const panel = document.getElementById("aiPanel");
  panel.classList.toggle("hidden");
  if (!panel.classList.contains("hidden") && !document.getElementById("aiMessages").children.length) {
    addMessage("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š", "bot");
  }
}

function addMessage(text, role="bot") {
  const wrap = document.getElementById("aiMessages");
  const bubble = document.createElement("div");
  bubble.className = (role === "user")
    ? "ml-auto max-w-[85%] p-3 rounded-2xl bg-orange-500 text-white text-sm shadow-soft"
    : "mr-auto max-w-[85%] p-3 rounded-2xl bg-white border text-slate-800 text-sm";

  bubble.textContent = text;
  wrap.appendChild(í’ì„ ê»Œ);
  wrap.scrollTop = wrap.scrollHeight;
}

function setSending(isSending) {
  document.getElementById("aiSendBtn").disabled = isSending;
  document.getElementById("quickAskBtn").disabled = isSending;
  document.getElementById("aiSendBtn").classList.toggle("opacity-60", isSending);
  document.getElementById("quickAskBtn").classList.toggle("opacity-60", isSending);
}

function buildContext() {
  if (!selectedItem) return "";
  const word = (selectedItem.word || selectedItem.hanja || selectedItem.char || selectedItem.text || "").toString();
  const meaning = (selectedItem.meaning_ko || selectedItem.meaning || selectedItem.kr || selectedItem.korean || selectedItem.gloss || "").toString();
  const pinyin = (selectedItem.pinyin || selectedItem.py || "").toString();

  const chars = extractHanziChars(word);
  const metaLines = chars.map(ch => {
    const m = HANZI_META[ch];
    return m
      ? `${ch}: ${prettyHSK(m.hsk)}, ë¶€ìˆ˜ ${m.radical}, íšìˆ˜ ${m.strokes}`
      : `${ch}: (ë©”íƒ€ ì—†ìŒ)`;
  }).join("\n");

  return [
    "í˜„ì¬ ì„ íƒí•œ í•­ëª© ì •ë³´:",
    `ë‹¨ì–´/í•œì: ${word}`,
    `ëœ»(í•œêµ­ì–´): ${meaning}`,
    pinyin ? `Pinyin: ${pinyin}` : "",
    "ê¸€ìë³„ HSK/ë¶€ìˆ˜/íšìˆ˜:",
    metaLines
  ].filter(Boolean).join("\n");
}

async function askAI() {
  const inputEl = document.getElementById("aiInput");
  const msg = (inputEl.value || "").trim();
  if (!msg) return;

  addMessage(msg, "user");
  inputEl.value = "";

  const prompt = buildContext()
    ? (buildContext() + "\n\nì‚¬ìš©ì ì§ˆë¬¸: " + msg)
    : msg;

  await sendToGemini(prompt);
}

async function quickAsk() {
  const inputEl = document.getElementById("quickQuestion");
  const msg = (inputEl.value || "").trim();
  if (!msg) return;

  // íŒ¨ë„ ì—´ê³  ëŒ€í™”ì— ë°˜ì˜
  if (document.getElementById("aiPanel").classList.contains("hidden")) toggleAI();

  addMessage(msg, "user");
  inputEl.value = "";

  const prompt = buildContext()
    ? (buildContext() + "\n\nì‚¬ìš©ì ì§ˆë¬¸: " + msg)
    : msg;

  await sendToGemini(prompt);
}

async function sendToGemini(prompt) {
  setSending(true);
  try {
    let data;

    if (GEMINI_KEY) {
      // âœ… ì„ì‹œ(ë¹„ì¶”ì²œ): í”„ë¡ íŠ¸ì—ì„œ ì§ì ‘ í˜¸ì¶œ
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(GEMINI_MODEL)}:generateContent?key=${encodeURIComponent(GEMINI_KEY)}`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [{ role: "user", parts: [{ text: prompt }] }],
          generationConfig: { temperature: 0.7, topP: 0.9, maxOutputTokens: 512 }
        })
      });
      data = await res.json();
      if (!res.ok) throw new Error(data?.error?.message || "ìš”ì²­ ì‹¤íŒ¨");

    } else {
      // âœ… ìš´ì˜(ì¶”ì²œ): ì„œë²„ë¦¬ìŠ¤ í”„ë¡ì‹œ í˜¸ì¶œ (/api/gemini)
      const res = await fetch(PROXY_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          model: GEMINI_MODEL,
          prompt
        })
      });
      data = await res.json();
      if (!res.ok) throw new Error(data?.error || data?.message || "í”„ë¡ì‹œ ìš”ì²­ ì‹¤íŒ¨");
    }

    const answer = extractGeminiText(data) || "ë‹µë³€ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¬ë¼ìš”)";
    addMessage(answer, "bot");

  } catch (e) {
    console.error(e);
    addMessage("ì˜¤ë¥˜: " + e.message, "bot");
  } finally {
    setSending(false);
  }
}

// Google ì‘ë‹µì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ (ì—¬ëŸ¬ í˜•ì‹ ëŒ€ì‘)
function extractGeminiText(data) {
  // direct API
  const t1 = data?.candidates?.[0]?.content?.parts?.map(p => p.text).filter(Boolean).join("");
  if (t1) return t1;

  // proxy API (ìš°ë¦¬ê°€ {text:"..."} í˜•íƒœë¡œ ë§Œë“¤ ìˆ˜ë„ ìˆìŒ)
  const t2 = data?.text;
  if (t2) return t2;

  return "";
}

/* =========================================================
   4) Utils
========================================================= */
function extractHanziChars(str) {
  if (!str) return [];
  const m = str.match(/[\u4E00-\u9FFF]/g);
  return m ? m : [];
}

function extractFirstHanzi(str) {
  const arr = extractHanziChars(str);
  return arr[0] || "";
}

function escapeHtml(str) {
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function openHelp() {
  document.getElementById("helpModal").classList.remove("hidden");
}
function closeHelp() {
  document.getElementById("helpModal").classList.add("hidden");
}

/* =========================================================
   Start
========================================================= */
initApp();
</script>
</body>
</html>
