<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HanjaPass PRO</title>

  <!-- âœ… Tailwind (ê°œë°œìš© CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{background:#fffaf5;font-family: "Malgun Gothic","Apple SD Gothic Neo",sans-serif;}
    .ai-fab{position:fixed;right:18px;bottom:18px;width:56px;height:56px;border-radius:999px;
      background:#111827;color:#fff;display:flex;align-items:center;justify-content:center;
      box-shadow:0 10px 25px rgba(0,0,0,.15);cursor:pointer;z-index:50;}
    .ai-modal{position:fixed;right:18px;bottom:90px;width:360px;max-width:92vw;
      background:#fff;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.18);overflow:hidden;z-index:60;}
    .ai-header{background:#111827;color:#fff;padding:12px 14px;font-weight:700;display:flex;align-items:center;justify-content:space-between;}
    .ai-body{padding:12px 12px 10px 12px;max-height:360px;overflow:auto;}
    .ai-msg{padding:10px 12px;border-radius:14px;margin:8px 0;line-height:1.35}
    .ai-bot{background:#f3f4f6;}
    .ai-user{background:#fb923c;color:#fff;margin-left:auto;max-width:80%;}
    .ai-inputbar{padding:10px 12px;border-top:1px solid #eee;display:flex;gap:8px;align-items:center;}
    .ai-inputbar input{flex:1;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;outline:none;}
    .ai-inputbar button{background:#fb923c;color:#fff;border-radius:12px;padding:10px 14px;font-weight:700;}
    .ai-foot{padding:0 12px 12px 12px;color:#6b7280;font-size:12px}
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-extrabold text-slate-900">HanjaPass PRO</h1>
    <p class="text-slate-600 mt-2">HSK ë‹¨ì–´/í‘œí˜„ì„ ì¹´ë“œë¡œ ë³´ê³ , ì˜ˆë¬¸ê³¼ ë°œìŒê¹Œì§€ í•œ ë²ˆì— í•™ìŠµí•˜ì„¸ìš”.</p>

    <!-- Top controls -->
    <div class="mt-6 flex flex-wrap gap-2 items-center">
      <label class="text-sm font-semibold text-slate-700">ëª©ë¡</label>
      <select id="levelSelect" class="border rounded-lg px-3 py-2 bg-white"></select>

      <select id="categorySelect" class="border rounded-lg px-3 py-2 bg-white"></select>

      <button id="viewCardBtn" class="border rounded-lg px-3 py-2 bg-white hover:bg-slate-50">
        ë³´ê¸°: ì¹´ë“œ
      </button>
      <button id="randomBtn" class="border rounded-lg px-3 py-2 bg-white hover:bg-slate-50">
        ëœë¤ ğŸ²
      </button>

      <input id="searchInput" class="border rounded-lg px-3 py-2 bg-white w-64 max-w-full" placeholder="ê²€ìƒ‰: ì¤‘êµ­ì–´/í•œì/ë³‘ìŒ/í•œêµ­ì–´" />
      <span id="countInfo" class="text-sm text-slate-500"></span>
    </div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-5">
      <!-- list -->
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between">
          <div class="font-bold text-slate-800">ë‹¨ì–´ ëª©ë¡</div>
          <div class="text-xs text-slate-500" id="selectedCount">ì„ íƒí•œ í•­ëª© ìˆ˜: 0</div>
        </div>
        <div id="listBox" class="mt-3 space-y-2 max-h-[70vh] overflow-auto"></div>
      </div>

      <!-- detail -->
      <div class="lg:col-span-2 bg-white rounded-2xl shadow p-5">
        <div class="text-lg font-bold text-slate-800">ìƒì„¸ ë³´ê¸°</div>
        <div class="text-sm text-slate-500 mt-1">ì™¼ìª½ì—ì„œ ë‹¨ì–´/í‘œí˜„ì„ ì„ íƒí•´ ì£¼ì„¸ìš” ğŸ™‚</div>

        <div id="detailBox" class="mt-4">
          <div class="text-slate-400">ì„ íƒí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>

        <hr class="my-6"/>

        <!-- AI -->
        <div class="text-lg font-bold text-slate-800">AIì—ê²Œ ì§ˆë¬¸í•˜ê¸°</div>
        <div class="text-sm text-slate-500 mt-1">ë‹¨ì–´ ì˜ë¯¸/ì‚¬ìš©ë²•/ì˜ˆë¬¸/ë¹„ìŠ·í•œ í‘œí˜„ ë“±ì„ ë¬¼ì–´ë³´ì„¸ìš”!</div>
        <div class="text-xs text-slate-400 mt-1">ì˜ˆ: â€œè¿™ä¸ª í‘œí˜„ HSK ëª‡ ê¸‰ì´ì•¼?â€, â€œì˜ˆë¬¸ 3ê°œ ë§Œë“¤ì–´ì¤˜.â€</div>
        <div class="mt-3 text-sm text-emerald-600">âœ… Key ë³´í˜¸ ëª¨ë“œ: <b>/api/gemini</b> ì‚¬ìš© ì¤‘ (í”„ë¡ íŠ¸ì— Key ì—†ìŒ)</div>
      </div>
    </div>
  </div>

  <!-- Floating AI button + modal -->
  <div class="ai-fab" onclick="toggleAI()" title="AI">
    ğŸ¤–
  </div>

  <div id="aiModal" class="ai-modal hidden">
    <div class="ai-header">
      <div>AI í•œì ì„ ìƒë‹˜</div>
      <button onclick="toggleAI()" class="opacity-80 hover:opacity-100">âœ•</button>
    </div>
    <div id="aiBody" class="ai-body">
      <div class="ai-msg ai-bot">ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š ê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ì˜ˆë¬¸/ë¬¸ë²•/ë¹„ìŠ·í•œ í‘œí˜„ì„ ë¬¼ì–´ë³´ì„¸ìš”!</div>
    </div>
    <div class="ai-inputbar">
      <input id="aiInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." />
      <button id="aiSendBtn" onclick="askAI()">ë³´ë‚´ê¸°</button>
    </div>
    <div class="ai-foot">ìš´ì˜ ê¶Œì¥: Vercel ì„œë²„ë¦¬ìŠ¤(<b>/api/gemini</b>)ë¡œ Key ë³´í˜¸</div>
  </div>

  <script>
    // ----------------- Data -----------------
    let globalData = {};
    let currentLevel = "HSK1";
    let currentCategory = "";
    let viewMode = "card"; // card only for now
    let selected = [];

    async function initApp(){
      try{
        const res = await fetch("data.json?t=" + Date.now());
        if(!res.ok) throw new Error("data.json fetch failed: " + res.status);
        globalData = await res.json();

        // level options
        const levels = Object.keys(globalData || {});
        if(levels.length === 0) throw new Error("No levels in data.json");

        currentLevel = levels.includes("HSK1") ? "HSK1" : levels[0];

        const levelSelect = document.getElementById("levelSelect");
        levelSelect.innerHTML = levels.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
        levelSelect.value = currentLevel;
        levelSelect.onchange = () => {
          currentLevel = levelSelect.value;
          selected = [];
          renderCategories();
          renderList();
          renderDetail();
        };

        renderCategories();
        renderList();
        renderDetail();

        document.getElementById("randomBtn").onclick = pickRandom;
        document.getElementById("searchInput").addEventListener("input", () => renderList());

        // Enter to send AI
        document.getElementById("aiInput").addEventListener("keydown", (e)=>{
          if(e.key === "Enter") askAI();
        });

      }catch(e){
        console.error(e);
        document.body.innerHTML = `
          <div class="max-w-xl mx-auto mt-20 bg-white rounded-2xl shadow p-6">
            <div class="text-red-600 font-bold text-lg">ì•—! ë¡œë”© ì˜¤ë¥˜</div>
            <div class="mt-2 text-slate-700">data.json ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ê°€ ìˆì–´ìš”.</div>
            <pre class="mt-3 text-xs bg-slate-100 p-3 rounded-xl overflow-auto">${escapeHtml(String(e))}</pre>
            <div class="mt-4 text-sm text-slate-500">GitHubì—ì„œ data.jsonì´ ì¡´ì¬í•˜ëŠ”ì§€, JSON í˜•ì‹ì´ ê¹¨ì§€ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</div>
          </div>
        `;
      }
    }

    function renderCategories(){
      const catsObj = globalData[currentLevel] || {};
      const cats = Object.keys(catsObj);
      currentCategory = cats[0] || "";

      const categorySelect = document.getElementById("categorySelect");
      categorySelect.innerHTML = cats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
      categorySelect.value = currentCategory;

      categorySelect.onchange = () => {
        currentCategory = categorySelect.value;
        selected = [];
        renderList();
        renderDetail();
      };
    }

    function getItems(){
      const catsObj = globalData[currentLevel] || {};
      const items = (catsObj[currentCategory] || []);
      return items;
    }

    function renderList(){
      const listBox = document.getElementById("listBox");
      const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();

      const items = getItems().filter(it => {
        if(!q) return true;
        const blob = `${it.cn||""} ${it.hj||""} ${it.py||""} ${it.kr||""} ${it.trans||""}`.toLowerCase();
        return blob.includes(q);
      });

      document.getElementById("countInfo").textContent = `í‘œì‹œ: ${items.length}ê°œ`;
      document.getElementById("selectedCount").textContent = `ì„ íƒí•œ í•­ëª© ìˆ˜: ${selected.length}`;

      listBox.innerHTML = items.map((it, idx) => {
        const key = itemKey(it, idx);
        const isSel = selected.some(s => s._key === key);
        return `
          <button class="w-full text-left border rounded-xl px-3 py-3 hover:bg-slate-50 ${isSel ? "bg-orange-50 border-orange-300" : "bg-white"}"
            onclick="toggleSelect('${escapeJs(key)}')">
            <div class="flex items-center justify-between">
              <div class="font-bold text-slate-900">${escapeHtml(it.cn || "")}</div>
              <div class="text-xs text-slate-500">${escapeHtml(it.py || "")}</div>
            </div>
            <div class="text-sm text-slate-600 mt-1">${escapeHtml(it.kr || it.trans || "")}</div>
          </button>
        `;
      }).join("") || `<div class="text-slate-400 text-sm">ëª©ë¡ì´ ë¹„ì–´ìˆì–´ìš”.</div>`;
    }

    function toggleSelect(key){
      const items = getItems();
      // find item by key
      let found = null;
      for(let i=0;i<items.length;i++){
        const k = itemKey(items[i], i);
        if(k === key){
          found = {...items[i], _key: k};
          break;
        }
      }
      if(!found) return;

      const exists = selected.some(s => s._key === key);
      if(exists){
        selected = selected.filter(s => s._key !== key);
      }else{
        selected = [found]; // single select (simpler)
      }
      renderList();
      renderDetail();
    }

    function renderDetail(){
      const box = document.getElementById("detailBox");
      if(selected.length === 0){
        box.innerHTML = `<div class="text-slate-400">ì„ íƒí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      const it = selected[0];

      box.innerHTML = `
        <div class="rounded-2xl border p-4">
          <div class="flex flex-wrap items-end justify-between gap-2">
            <div>
              <div class="text-3xl font-extrabold text-slate-900">${escapeHtml(it.cn || "")}</div>
              <div class="text-slate-600 mt-1">
                <span class="font-semibold">${escapeHtml(it.py || "")}</span>
                <span class="mx-2">Â·</span>
                <span>${escapeHtml(it.kr || "")}</span>
              </div>
              ${it.trans ? `<div class="text-slate-500 text-sm mt-1">${escapeHtml(it.trans)}</div>` : ""}
            </div>
            <div class="flex gap-2">
              <button class="border rounded-xl px-3 py-2 hover:bg-slate-50" onclick="speakPinyin('${escapeJs(it.py||"")}')">ğŸ”Š ë°œìŒ</button>
              <button class="border rounded-xl px-3 py-2 hover:bg-slate-50" onclick="copyText('${escapeJs(it.cn||"")}')">ğŸ“‹ ë³µì‚¬</button>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="bg-slate-50 rounded-xl p-3">
              <div class="text-xs font-bold text-slate-500">ì˜ˆë¬¸(ì¤‘ë¬¸)</div>
              <div class="mt-1 text-slate-800">${escapeHtml(it.sentence_cn || "â€”")}</div>
            </div>
            <div class="bg-slate-50 rounded-xl p-3">
              <div class="text-xs font-bold text-slate-500">ì˜ˆë¬¸(ë³‘ìŒ)</div>
              <div class="mt-1 text-slate-800">${escapeHtml(it.sentence_py || "â€”")}</div>
            </div>
          </div>
        </div>
      `;
    }

    function pickRandom(){
      const items = getItems();
      if(items.length === 0) return;
      const idx = Math.floor(Math.random()*items.length);
      const it = {...items[idx], _key: itemKey(items[idx], idx)};
      selected = [it];
      renderList();
      renderDetail();
    }

    // ----------------- Pronunciation -----------------
    function speakPinyin(py){
      if(!py) return;
      try{
        const u = new SpeechSynthesisUtterance(py);
        u.lang = "zh-CN";
        speechSynthesis.cancel();
        speechSynthesis.speak(u);
      }catch(e){
        alert("ë°œìŒ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
      }
    }

    function copyText(t){
      if(!t) return;
      navigator.clipboard.writeText(t).then(()=> {
        toast("ë³µì‚¬ ì™„ë£Œ!");
      }).catch(()=> {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        toast("ë³µì‚¬ ì™„ë£Œ!");
      });
    }

    function toast(msg){
      const d = document.createElement("div");
      d.className = "fixed left-1/2 -translate-x-1/2 bottom-6 bg-slate-900 text-white px-4 py-2 rounded-xl shadow z-[100]";
      d.textContent = msg;
      document.body.appendChild(d);
      setTimeout(()=> d.remove(), 1200);
    }

    // ----------------- AI modal -----------------
    function toggleAI(){
      document.getElementById("aiModal").classList.toggle("hidden");
      setTimeout(()=> document.getElementById("aiInput").focus(), 50);
    }

    function addAiMsg(text, who){
      const body = document.getElementById("aiBody");
      const div = document.createElement("div");
      div.className = "ai-msg " + (who === "user" ? "ai-user" : "ai-bot");
      div.textContent = text;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
    }

    async function askAI(){
      const input = document.getElementById("aiInput");
      const btn = document.getElementById("aiSendBtn");
      const msg = (input.value || "").trim();
      if(!msg) return;

      addAiMsg(msg, "user");
      input.value = "";

      btn.disabled = true;
      btn.style.opacity = "0.7";

      try{
        // âœ… IMPORTANT: relative path -> works on Vercel domain
        const r = await fetch("/api/gemini", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ message: msg, context: selected[0] || null })
        });

        const data = await r.json().catch(()=> ({}));

        if(!r.ok){
          const err = data?.error || ("HTTP " + r.status);
          addAiMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err, "bot");
          return;
        }

        const answer = data?.text || data?.answer || "";
        addAiMsg(answer || "ë‹µë³€ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¬ë¼ìš”)", "bot");

      }catch(e){
        console.error(e);
        addAiMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "bot");
      }finally{
        btn.disabled = false;
        btn.style.opacity = "1";
      }
    }

    // ----------------- Utils -----------------
    function itemKey(it, idx){
      return `${currentLevel}__${currentCategory}__${idx}__${it.cn||""}__${it.py||""}`;
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeJs(str){
      return String(str).replaceAll("\\","\\\\").replaceAll("'","\\'").replaceAll("\n","\\n");
    }

    initApp();
  </script>
</body>
</html>
