<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind (ê°œë°œìš©) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="p-4">

  <!-- âœ… í˜ì´ì§€ê°€ í•˜ì–—ê²Œë§Œ ë³´ì´ëŠ”ì§€ í™•ì¸ìš© (ì •ìƒì´ë¼ë©´ ì´ ë¬¸êµ¬ê°€ ë³´ì…ë‹ˆë‹¤) -->
  <div class="max-w-xl mx-auto mb-4">
    <div class="bg-white rounded-xl shadow p-4">
      <div class="text-lg font-semibold">âœ… AI í•œì ì„ ìƒë‹˜</div>
      <div class="text-sm text-gray-600 mt-1">
        í˜ì´ì§€ê°€ ì´ ì¹´ë“œê¹Œì§€ ë³´ì´ë©´, ì •ì (index.html) ë°°í¬ëŠ” ì •ìƒì…ë‹ˆë‹¤.
      </div>

      <!-- âœ… API ìƒíƒœ ì ê²€ ë²„íŠ¼ -->
      <div class="mt-3 flex gap-2">
        <button onclick="pingApi()"
          class="bg-black text-white px-3 py-2 rounded-lg text-sm">
          API ìƒíƒœ ì ê²€
        </button>
        <div id="pingResult" class="text-sm text-gray-700"></div>
      </div>

      <!-- âœ… ë””ë²„ê·¸ ë¡œê·¸ -->
      <pre id="debug" class="mt-3 p-3 bg-gray-100 rounded-lg text-xs mono whitespace-pre-wrap"></pre>
    </div>
  </div>

  <!-- âœ… í”Œë¡œíŒ… ë²„íŠ¼ -->
  <button onclick="toggleAI()"
    class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
    ğŸ¤–
  </button>

  <!-- âœ… AI íŒ¨ë„ -->
  <div id="ai-panel"
    class="hidden fixed bottom-20 right-4 w-[360px] bg-white rounded-xl shadow-xl flex flex-col overflow-hidden">

    <div class="bg-black text-white px-4 py-2 flex justify-between items-center">
      <span class="font-semibold">AI í•œì ì„ ìƒë‹˜</span>
      <button onclick="toggleAI()" class="text-white/80 hover:text-white">âœ–</button>
    </div>

    <!-- âœ… TTS ì˜ì—­ -->
    <div class="px-3 pt-3 text-xs flex items-center gap-2">
      <label class="flex items-center gap-1">
        <input id="ttsToggle" type="checkbox" class="accent-orange-500" checked />
        ì½ì–´ì£¼ê¸°(TTS)
      </label>

      <select id="voiceSelect"
        class="border rounded px-2 py-1 text-xs flex-1"
        onchange="selectedVoiceName=this.value">
      </select>
    </div>

    <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

    <div class="p-3 border-t flex gap-2">
      <input id="input"
        class="flex-1 border rounded px-2 py-2"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦"
        onkeydown="if(event.key==='Enter') send();" />
      <button onclick="send()"
        class="bg-orange-500 text-white px-4 py-2 rounded">
        ë³´ë‚´ê¸°
      </button>
    </div>

    <div class="text-xs text-center text-gray-500 pb-2">
      ğŸ” Key ë³´í˜¸ ëª¨ë“œ: /api/gemini
    </div>
  </div>

<script>
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");
const debugEl = document.getElementById("debug");
const pingResult = document.getElementById("pingResult");

function logDebug(msg) {
  const t = new Date().toLocaleTimeString();
  debugEl.textContent = `[${t}] ${msg}\n` + debugEl.textContent;
}

function toggleAI() {
  panel.classList.toggle("hidden");
}

function escapeHtml(str) {
  return str
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function addMsg(text, who) {
  const div = document.createElement("div");
  div.className = who === "user" ? "text-right" : "text-left text-gray-800";

  const safe = escapeHtml(text).replaceAll("\n", "<br/>");

  div.innerHTML = `<span class="inline-block px-3 py-2 rounded-lg ${
    who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"
  }">${safe}</span>`;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* =========================
   âœ… TTS (Web Speech API)
========================= */
let voices = [];
let selectedVoiceName = "";

function loadVoices() {
  if (!("speechSynthesis" in window)) return;

  voices = window.speechSynthesis.getVoices();
  const sel = document.getElementById("voiceSelect");
  if (!sel) return;

  sel.innerHTML = "";

  const filtered = voices.filter(v =>
    v.lang.startsWith("ko") || v.lang.startsWith("zh") || v.lang.startsWith("en")
  );

  (filtered.length ? filtered : voices).forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.name;
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });

  const defaultVoice =
    voices.find(v => v.lang.startsWith("ko")) ||
    voices.find(v => v.lang.startsWith("zh")) ||
    voices[0];

  if (defaultVoice) {
    selectedVoiceName = defaultVoice.name;
    sel.value = defaultVoice.name;
  }
}

if ("speechSynthesis" in window) {
  window.speechSynthesis.onvoiceschanged = loadVoices;
  setTimeout(loadVoices, 300);
}

function speak(text) {
  if (!("speechSynthesis" in window)) return;
  const toggle = document.getElementById("ttsToggle");
  if (!toggle?.checked) return;

  const shortText = text.length > 700 ? text.slice(0, 700) + "â€¦" : text;

  window.speechSynthesis.cancel();
  const utter = new SpeechSynthesisUtterance(shortText);

  const v = voices.find(x => x.name === selectedVoiceName);
  if (v) utter.voice = v;

  utter.rate = 1.0;
  utter.pitch = 1.0;
  utter.volume = 1.0;

  window.speechSynthesis.speak(utter);
}

/* =========================
   âœ… API ìƒíƒœ ì ê²€
========================= */
async function pingApi() {
  pingResult.textContent = "ì ê²€ ì¤‘...";
  try {
    const res = await fetch("/api/gemini", { method: "GET" });
    const txt = await res.text();
    pingResult.textContent = `GET /api/gemini â†’ ${res.status}`;
    logDebug(`GET /api/gemini status=${res.status}\n${txt}`);
  } catch (e) {
    pingResult.textContent = "ì‹¤íŒ¨";
    logDebug("PING ERROR: " + e.message);
  }
}

/* =========================
   âœ… ë©”ì‹œì§€ ì „ì†¡
========================= */
async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  addMsg(msg, "user");
  input.value = "";

  try {
    logDebug("POST /api/gemini -> sending...");

    const res = await fetch("/api/gemini", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: msg })
    });

    const raw = await res.text(); // âœ… ë¨¼ì € textë¡œ ë°›ì•„ì„œ ë””ë²„ê·¸ ê°€ëŠ¥í•˜ê²Œ
    logDebug(`RESPONSE status=${res.status}\nRAW=${raw}`);

    if (!res.ok) {
      // ì—ëŸ¬ë„ JSONì¼ ìˆ˜ ìˆê³  ì•„ë‹ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì•ˆì „ ì²˜ë¦¬
      try {
        const ejson = JSON.parse(raw);
        addMsg(`ì˜¤ë¥˜: ${ejson.error || raw}`, "ai");
      } catch {
        addMsg(`ì˜¤ë¥˜: ${raw}`, "ai");
      }
      return;
    }

    // ì •ìƒì¼ ë•Œ JSON íŒŒì‹±
    const data = JSON.parse(raw);
    const answer = data.text || "(ì‘ë‹µ ì—†ìŒ)";
    addMsg(answer, "ai");
    speak(answer);

  } catch (e) {
    addMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.", "ai");
    logDebug("SEND ERROR: " + e.message);
  }
}

// ì´ˆê¸° í™˜ì˜
addMsg("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š\nê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ë¬¸ë²•ì„ ë¬¼ì–´ë³´ì„¸ìš”!", "ai");
</script>

</body>
</html>
