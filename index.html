<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    .bubble { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="p-4">

<button onclick="toggleAI()"
  class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
  ğŸ¤–
</button>

<div id="ai-panel"
  class="hidden fixed bottom-20 right-4 w-[380px] bg-white rounded-xl shadow-xl flex flex-col">

  <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
    <span>AI í•œì ì„ ìƒë‹˜</span>
    <button onclick="toggleAI()">âœ–</button>
  </div>

  <!-- æ§åˆ¶åŒº -->
  <div class="px-3 pt-3 pb-2 border-b text-xs space-y-2">
    <div class="flex items-center gap-2">
      <input id="ttsToggle" type="checkbox" checked class="accent-orange-500" />
      <label>ì½ì–´ì£¼ê¸°(TTS)</label>
    </div>

    <div class="flex items-center gap-2">
      <span class="w-[70px] text-gray-600">ìŒìƒ‰</span>
      <select id="voiceSelect" class="flex-1 border rounded px-2 py-1 text-xs"></select>
    </div>

    <div class="flex items-center gap-2">
      <span class="w-[70px] text-gray-600">ì„¤ëª… ì–¸ì–´</span>
      <select id="explainLang" class="flex-1 border rounded px-2 py-1 text-xs">
        <option value="ko" selected>í•œêµ­ì–´</option>
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="en">English</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>
  </div>

  <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

  <div class="p-3 border-t flex gap-2">
    <input id="input" class="flex-1 border rounded px-2 py-2"
      placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" 
      onkeydown="if(event.key==='Enter') send();" />
    <button onclick="send()" class="bg-orange-500 text-white px-4 py-2 rounded">
      ë³´ë‚´ê¸°
    </button>
  </div>

  <div class="text-xs text-center text-gray-500 pb-2">
    ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel API
  </div>
</div>

<script>
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");
const explainLang = document.getElementById("explainLang");
const ttsToggle = document.getElementById("ttsToggle");
const voiceSelect = document.getElementById("voiceSelect");

const API_URL = "https://hanjiapass.vercel.app/api/gemini";

/* âœ… æ¬¢è¿è¯­ï¼ˆéšè¯­è¨€ï¼‰ */
const WELCOME_TEXT = {
  ko: "ì•ˆë…•í•˜ì„¸ìš” ğŸ™‚\nì¤‘êµ­ì–´ ì§ˆë¬¸, ë°”ë¡œ ë¬¼ì–´ë³´ì„¸ìš”!",
  ja: "ã“ã‚“ã«ã¡ã¯ ğŸ™‚\nä¸­å›½èªã€æ°—è»½ã«èã„ã¦ãã ã•ã„ã€‚",
  en: "Hi ğŸ™‚\nAsk me anything about Chinese!",
  zh: "ä½ å¥½ ğŸ™‚\næœ‰ä¸­æ–‡é—®é¢˜ï¼Œç›´æ¥é—®æˆ‘å§ã€‚"
};

function toggleAI() {
  panel.classList.toggle("hidden");
}

function cleanForDisplay(text) {
  return String(text)
    .replace(/```[\s\S]*?```/g, "")
    .replace(/\*\*(.*?)\*\*/g, "$1")
    .replace(/#+\s*/g, "")
    .replace(/-{3,}/g, "")
    .trim();
}

function addMsg(text, who) {
  const div = document.createElement("div");
  div.className = who === "user" ? "text-right" : "text-left";
  div.innerHTML = `
    <span class="inline-block px-3 py-2 rounded-lg ${
      who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"
    }">
      <div class="bubble">${cleanForDisplay(text)}</div>
    </span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function send() {
  const msg = input.value.trim();
  if (!msg) return;
  addMsg(msg, "user");
  input.value = "";

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      prompt: msg,
      explainLang: explainLang.value
    })
  });

  const data = await res.json();
  addMsg(data.text || "(ì‘ë‹µ ì—†ìŒ)", "ai");
}

/* âœ… åˆå§‹åŒ–æ¬¢è¿è¯­ + è¯­è¨€åˆ‡æ¢è‡ªåŠ¨æ›´æ–° */
function showWelcome() {
  chat.innerHTML = "";
  addMsg(WELCOME_TEXT[explainLang.value], "ai");
}

explainLang.addEventListener("change", showWelcome);
showWelcome();
</script>

</body>
</html>
