<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI í•œì ì„ ìƒë‹˜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background:#f7f7f7; }
    .chat-box { max-height: 60vh; overflow-y: auto; }
    pre { white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="p-4">

  <button onclick="toggleAI()"
    class="fixed bottom-4 right-4 bg-black text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg">
    ğŸ¤–
  </button>

  <div id="ai-panel"
    class="hidden fixed bottom-20 right-4 w-[340px] bg-white rounded-xl shadow-xl flex flex-col">

    <div class="bg-black text-white px-4 py-2 rounded-t-xl flex justify-between items-center">
      <span>AI í•œì ì„ ìƒë‹˜</span>
      <button onclick="toggleAI()">âœ–</button>
    </div>

    <div id="chat" class="chat-box p-3 space-y-2 text-sm"></div>

    <div class="p-3 border-t flex gap-2">
      <input id="input"
        class="flex-1 border rounded px-2 py-1"
        placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" />
      <button onclick="send()"
        class="bg-orange-500 text-white px-3 py-1 rounded">
        ë³´ë‚´ê¸°
      </button>
    </div>

    <div class="text-xs text-center text-gray-500 pb-2">
      ğŸ” Key ë³´í˜¸ ëª¨ë“œ: Vercel API
    </div>
  </div>

<script>
const panel = document.getElementById("ai-panel");
const chat  = document.getElementById("chat");
const input = document.getElementById("input");

// âœ… ç»å¯¹åœ°å€ï¼ˆä½ è¦çš„ï¼‰
const API_URL = "https://hanjiapass.vercel.app/api/gemini";

function toggleAI() {
  panel.classList.toggle("hidden");
}

function addMsg(text, who) {
  const div = document.createElement("div");
  div.className = who === "user" ? "text-right" : "text-left text-gray-800";
  div.innerHTML = `
    <span class="inline-block px-3 py-2 rounded-lg ${who === "user" ? "bg-orange-500 text-white" : "bg-gray-200"}">
      <pre>${escapeHtml(text)}</pre>
    </span>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function escapeHtml(str) {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

async function send() {
  const msg = input.value.trim();
  if (!msg) return;

  addMsg(msg, "user");
  input.value = "";

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt: msg })
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      // æŠŠåç«¯è¿”å›çš„ error ç›´æ¥æ˜¾ç¤ºå‡ºæ¥ï¼Œè°ƒè¯•ä¼šéå¸¸å¿«
      throw new Error((data && (data.error || JSON.stringify(data))) || ("HTTP " + res.status));
    }

    addMsg(data.text || "(ì‘ë‹µ ì—†ìŒ)", "ai");
  } catch (e) {
    addMsg("ì˜¤ë¥˜: " + (e.message || "ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."), "ai");
  }
}

addMsg("ì•ˆë…•í•˜ì„¸ìš”! HSK í•œì ì„ ìƒë‹˜ì…ë‹ˆë‹¤ ğŸ˜Š\nê¶ê¸ˆí•œ ë‹¨ì–´ë‚˜ ë¬¸ë²•ì„ ë¬¼ì–´ë³´ì„¸ìš”!", "ai");
</script>

</body>
</html>
